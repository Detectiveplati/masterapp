<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Procurement Request ÈááË¥≠Áî≥ËØ∑</title>
  <link rel="stylesheet" href="/css/app.css"/>
</head>
<body data-module="procurement">

<main>
  <div id="msgSuccess" class="msg success" style="display:none">‚úÖ <span class="t" data-en="Request submitted successfully!" data-zh="Áî≥ËØ∑Êèê‰∫§ÊàêÂäüÔºÅ">Request submitted successfully!</span></div>
  <div id="msgError"   class="msg error"   style="display:none">‚ùå <span id="errText">Failed to submit. Please try again.</span></div>

  <form id="requestForm" enctype="multipart/form-data" style="max-width:680px;margin:0 auto;">

    <div class="card">
      <h2>üì¶ <span class="t" data-en="Item Request" data-zh="ÈááË¥≠Áî≥ËØ∑">Item Request</span></h2>

      <div class="form-row">
        <div class="form-group">
          <label><span class="t" data-en="Item Requested" data-zh="ÈááË¥≠Áâ©ÂìÅ">Item Requested</span> <span style="color:var(--accent)">*</span></label>
          <input type="text" name="itemNameEn" id="itemNameInput"
            placeholder="e.g. Commercial Blender / ÂïÜÁî®ÊêÖÊãåÊú∫" required/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="t" data-en="Quantity" data-zh="Êï∞Èáè">Quantity</label>
          <input type="number" name="quantity" id="qtyInput" placeholder="e.g. 2" min="1" step="1" inputmode="numeric"/>
        </div>
        <div class="form-group">
          <label class="t" data-en="Department" data-zh="ÈÉ®Èó®">Department</label>
          <input type="text" name="department" id="deptInput" placeholder="e.g. Pastry, Wok Station"/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label><span class="t" data-en="Your Name" data-zh="ÂßìÂêç">Your Name</span> <span style="color:var(--accent)">*</span></label>
          <input type="text" name="requestorName" id="nameInput" placeholder="Full name / ÂÖ®Âêç" required/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="t" data-en="Comments / Reason" data-zh="Â§áÊ≥® / ÂéüÂõ†">Comments / Reason</label>
          <textarea name="comments" id="commentsInput"
            placeholder="Why is this item needed? / ‰∏∫‰ªÄ‰πàÈúÄË¶ÅÊ≠§Áâ©ÂìÅÔºü"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="t" data-en="Photo (optional, max 5MB)" data-zh="ÁÖßÁâáÔºàÂèØÈÄâÔºåÊúÄÂ§ß 5MBÔºâ">Photo (optional, max 5MB)</label>
          <input type="file" name="image" id="imageInput" accept="image/*"/>
          <img id="imagePreview" style="max-width:220px;max-height:170px;border-radius:10px;margin-top:10px;display:none;border:1px solid var(--border);" alt="Preview"/>
        </div>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;">
        <button type="submit" class="btn btn-primary">
          ‚úÖ <span class="t" data-en="Submit Request" data-zh="Êèê‰∫§Áî≥ËØ∑">Submit Request</span>
        </button>
        <a href="/procurement" class="btn btn-outline">
          <span class="t" data-en="Cancel" data-zh="ÂèñÊ∂à">Cancel</span>
        </a>
      </div>
    </div>

  </form>
</main>

<style>
  .lang-toggle {
    background: transparent;
    border: 2px solid rgba(192,57,43,0.35);
    color: var(--accent);
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: none;
  }
  .lang-toggle:hover {
    background: rgba(192,57,43,0.08);
    transform: none;
    box-shadow: none;
  }
</style>

<script>
  // ‚îÄ‚îÄ Language ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const LABELS = {
    en: { title: 'Procurement Request', sub: 'Central Kitchen ¬∑ Submit a new item request', toggle: '‰∏≠Êñá' },
    zh: { title: 'ÈááË¥≠Áî≥ËØ∑', sub: '‰∏≠Â§ÆÂé®Êàø ¬∑ Êèê‰∫§Êñ∞ÁöÑÁâ©ÂìÅÁî≥ËØ∑', toggle: 'EN' }
  };
  const PLACEHOLDERS = {
    en: { item: 'e.g. Commercial Blender / ÂïÜÁî®ÊêÖÊãåÊú∫', qty: 'e.g. 2', dept: 'e.g. Pastry, Wok Station', name: 'Full name / ÂÖ®Âêç', comments: 'Why is this item needed? Any special notes?' },
    zh: { item: '‰æãÔºöÂïÜÁî®ÊêÖÊãåÊú∫ / Commercial Blender', qty: '‰æãÔºö2', dept: '‰æãÔºöÁÉ§ÁÑóÈÉ®', name: 'ÂÖ®Âêç / Full Name', comments: '‰∏∫‰ªÄ‰πàÈúÄË¶ÅÊ≠§Áâ©ÂìÅÔºüÊúâÁâπÂà´ËØ¥ÊòéÂêóÔºü' }
  };

  let lang = navigator.language.toLowerCase().startsWith('zh') ? 'zh' : 'en';

  function applyLang() {
    document.querySelectorAll('.t').forEach(el => {
      const val = el.dataset[lang];
      if (val) el.textContent = val;
    });
    document.getElementById('hdr-title').textContent  = LABELS[lang].title;
    document.getElementById('hdr-sub').textContent    = LABELS[lang].sub;
    document.getElementById('langToggle').textContent = LABELS[lang].toggle;
    document.getElementById('itemNameInput').placeholder = PLACEHOLDERS[lang].item;
    document.getElementById('qtyInput').placeholder      = PLACEHOLDERS[lang].qty;
    document.getElementById('deptInput').placeholder     = PLACEHOLDERS[lang].dept;
    document.getElementById('nameInput').placeholder     = PLACEHOLDERS[lang].name;
    document.getElementById('commentsInput').placeholder = PLACEHOLDERS[lang].comments;
  }

  function toggleLang() {
    lang = lang === 'en' ? 'zh' : 'en';
    applyLang();
  }

  applyLang();

  // ‚îÄ‚îÄ Image preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('imageInput').addEventListener('change', function () {
    const file = this.files[0];
    const preview = document.getElementById('imagePreview');
    if (file) { preview.src = URL.createObjectURL(file); preview.style.display = 'block'; }
    else       { preview.style.display = 'none'; }
  });

  // ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('requestForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const msgOk  = document.getElementById('msgSuccess');
    const msgErr = document.getElementById('msgError');
    msgOk.style.display = 'none';
    msgErr.style.display = 'none';

    const submitBtn = this.querySelector('[type="submit"]');
    const origHtml  = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = lang === 'zh' ? '‚è≥ Êèê‰∫§‰∏≠‚Ä¶' : '‚è≥ Submitting‚Ä¶';

    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);
      const res = await fetch('/api/requests', { method: 'POST', credentials: 'include', body: new FormData(this), signal: controller.signal });
      clearTimeout(timeout);
      if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Server error'); }
      msgOk.style.display = 'block';
      this.reset();
      document.getElementById('imagePreview').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
      document.getElementById('errText').textContent = lang === 'zh'
        ? `Êèê‰∫§Â§±Ë¥•Ôºö${err.name === 'AbortError' ? 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑ÈáçËØï' : err.message}`
        : `Failed: ${err.name === 'AbortError' ? 'Request timed out, please try again' : err.message}`;
      msgErr.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = origHtml;
    }
  });
</script>
  <script src="/js/shell.js"></script>
</body>
</html>