<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Equipment Issue | Êä•ÂëäËÆæÂ§áÈóÆÈ¢ò</title>
    <link rel="stylesheet" href="/css/app.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: calc(var(--topnav-h) + 24px) 16px 40px;
        }

        .logo-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo-header h1 {
            font-size: 1.1rem;
            color: #64748b;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.10);
            padding: 28px 24px;
            width: 100%;
            max-width: 480px;
        }

        .equipment-banner {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .equipment-banner .icon {
            font-size: 2rem;
            line-height: 1;
        }

        .equipment-banner .info h2 {
            font-size: 1.1rem;
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .equipment-banner .info p {
            font-size: 0.82rem;
            color: #64748b;
        }

        h3 {
            font-size: 1.2rem;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .subtitle {
            font-size: 0.88rem;
            color: #64748b;
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 0.88rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        label .optional {
            font-weight: 400;
            color: #94a3b8;
            font-size: 0.82rem;
        }

        textarea, input[type="text"] {
            width: 100%;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 1rem;
            font-family: inherit;
            color: #1e293b;
            background: #f8fafc;
            transition: border-color 0.2s;
            resize: vertical;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            background: #fff;
        }

        textarea {
            min-height: 130px;
        }

        .field {
            margin-bottom: 18px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #ef4444;
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s, transform 0.1s;
            letter-spacing: 0.3px;
        }

        .submit-btn:hover { background: #dc2626; }
        .submit-btn:active { transform: scale(0.98); }
        .submit-btn:disabled { background: #94a3b8; cursor: not-allowed; }

        .success-state {
            text-align: center;
            padding: 16px 0;
            display: none;
        }

        .success-state .tick {
            font-size: 3.5rem;
            margin-bottom: 12px;
        }

        .success-state h2 {
            font-size: 1.3rem;
            color: #16a34a;
            margin-bottom: 8px;
        }

        .success-state p {
            color: #64748b;
            font-size: 0.92rem;
            margin-bottom: 24px;
        }

        .report-another-btn {
            background: #f1f5f9;
            color: #374151;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .error-msg {
            background: #fef2f2;
            color: #b91c1c;
            border-radius: 8px;
            padding: 11px 14px;
            font-size: 0.88rem;
            margin-bottom: 16px;
            display: none;
        }

        .loading-banner {
            text-align: center;
            color: #94a3b8;
            padding: 18px 0;
            font-size: 0.95rem;
        }

        .not-found-banner {
            text-align: center;
            padding: 18px 0;
            display: none;
        }

        .not-found-banner .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .not-found-banner p { color: #64748b; font-size: 0.95rem; }

        /* Equipment selector */
        .selector-section { margin-bottom: 4px; }
        .selector-section h3 { font-size: 1.15rem; color: #1e293b; margin-bottom: 6px; }
        .selector-section p  { font-size: 0.88rem; color: #64748b; margin-bottom: 18px; }
        .eq-select {
            width: 100%;
            padding: 13px 14px;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            color: #1e293b;
            background: #f8fafc;
            cursor: pointer;
            margin-bottom: 14px;
        }
        .eq-select:focus { outline: none; border-color: #3b82f6; background: #fff; }
        .btn-select-eq {
            width: 100%;
            padding: 13px;
            background: #ef4444;
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        .btn-select-eq:disabled { background: #94a3b8; cursor: not-allowed; }

        .lang-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            width: 100%;
            max-width: 480px;
        }

        .lang-btn {
            background: #fff;
            border: 1.5px solid #e2e8f0;
            border-radius: 20px;
            padding: 5px 4px;
            display: flex;
            gap: 2px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
        }

        .lang-btn button {
            background: transparent;
            border: none;
            padding: 5px 14px;
            border-radius: 16px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            color: #64748b;
            transition: background 0.15s, color 0.15s;
        }

        .lang-btn button.active {
            background: #3b82f6;
            color: #fff;
        }

        /* Photo upload */
        .photo-upload-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 13px 14px;
            border: 1.5px dashed #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            cursor: pointer;
            font-size: 0.88rem;
            color: #64748b;
            font-weight: 500;
            transition: border-color 0.15s, background 0.15s;
        }
        .photo-upload-label:hover { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .photo-upload-label input { display: none; }
        .photo-preview { margin-top: 8px; display: none; }
        .photo-preview img { max-width: 100%; max-height: 180px; border-radius: 8px; border: 1px solid #e2e8f0; object-fit: cover; }
        .photo-name { font-size: 0.78rem; color: #94a3b8; margin-top: 4px; }
    </style>
</head>
<body data-module="maintenance">

    <div class="logo-header">        <a href="maintenance.html" style="display:inline-block;margin-bottom:10px;font-size:0.82rem;font-weight:700;color:#64748b;text-decoration:none;padding:5px 12px;border:1px solid #e2e8f0;border-radius:8px;background:#f8fafc;">‚Üê Maintenance Dashboard</a>        <h1>üçΩÔ∏è Central Kitchen Maintenance</h1>
    </div>

    <!-- Language toggle -->
    <div class="lang-toggle">
        <div class="lang-btn">
            <button id="btnEN" class="active" onclick="setLang('en')">EN</button>
            <button id="btnZH" onclick="setLang('zh')">‰∏≠Êñá</button>
        </div>
    </div>

    <div class="card">

        <!-- Equipment info banner -->
        <div id="loadingBanner" class="loading-banner">Loading equipment info‚Ä¶</div>

        <div id="notFoundBanner" class="not-found-banner">
            <div class="icon">‚ùì</div>
            <p id="notFoundText">Equipment not found. Please scan the QR code again.</p>
        </div>

        <!-- Manual equipment selector (shown when no ?id= in URL) -->
        <div id="selectorArea" style="display:none;">
            <div class="selector-section">
                <h3>‚ö†Ô∏è Report an Equipment Issue</h3>
                <p>Select the equipment you want to report an issue for.</p>
                <select class="eq-select" id="eqDropdown">
                    <option value="">‚Äî Select equipment ‚Äî</option>
                </select>
                <button class="btn-select-eq" id="btnSelectEq" onclick="selectEquipment()" disabled>Continue</button>
            </div>
        </div>

        <!-- Report form -->
        <div id="formArea" style="display:none;">
            <div class="equipment-banner" id="equipmentBanner">
                <div class="icon" id="equipmentIcon">‚öôÔ∏è</div>
                <div class="info">
                    <h2 id="equipmentName">‚Äî</h2>
                    <p id="equipmentMeta">‚Äî</p>
                </div>
            </div>

            <h3 id="formTitle">‚ö†Ô∏è Report an Issue</h3>
            <p class="subtitle" id="formSubtitle">Describe the problem with this equipment clearly.</p>

            <div id="errorMsg" class="error-msg"></div>

            <div id="reportForm">
                <div class="field">
                    <label for="description" id="labelDescription">What is the issue? *</label>
                    <textarea id="description" required></textarea>
                </div>
                <div class="field">
                    <label for="reportedBy">
                        <span id="labelName">Your name</span>
                        <span class="optional" id="labelOptional"> (optional)</span>
                    </label>
                    <input type="text" id="reportedBy">
                </div>
                <div class="field">
                    <label>
                        <span id="labelPhoto">Photo</span>
                        <span class="optional"> (optional)</span>
                    </label>
                    <label class="photo-upload-label" for="issuePhoto">
                        <span>üì∏</span>
                        <span id="photoLabelText">Tap to attach a photo</span>
                        <input type="file" id="issuePhoto" accept="image/*" capture="environment" onchange="handlePhotoSelect(this)">
                    </label>
                    <div class="photo-preview" id="photoPreview">
                        <img id="photoPreviewImg" src="" alt="Preview">
                        <div class="photo-name" id="photoFileName"></div>
                    </div>
                </div>
                <button class="submit-btn" id="submitBtn" onclick="submitReport()">Submit Report</button>
            </div>

            <div class="success-state" id="successState">
                <div class="tick">‚úÖ</div>
                <h2 id="successTitle">Issue Reported!</h2>
                <p id="successMsg">Thank you. The maintenance team has been notified and will address the issue.</p>
                <button class="report-another-btn" onclick="resetForm()" id="reportAnotherBtn">Report Another Issue</button>
            </div>
        </div>

    </div>

    <script src="js/api.js"></script>
    <script>
        const typeIcons = {
            'Walk-In Freezer': 'üßä',
            'Standing Freezer': 'üßä',
            'Walk-In Chiller': '‚ùÑÔ∏è',
            'Standing Chiller': '‚ùÑÔ∏è',
            'Warmer': 'üî•'
        };

        const translations = {
            en: {
                loading:        'Loading equipment info‚Ä¶',
                notFound:       'Equipment not found. Please scan the QR code again.',
                formTitle:      '‚ö†Ô∏è Report an Issue',
                formSubtitle:   'Describe the problem with this equipment clearly.',
                labelDesc:      'What is the issue? *',
                descPlaceholder:'e.g. The door seal is broken and the freezer is not maintaining temperature‚Ä¶',
                labelName:      'Your name',
                labelOptional:  ' (optional)',
                namePlaceholder:'e.g. John',
                submitBtn:      'Submit Report',
                submitting:     'Submitting‚Ä¶',
                successTitle:   'Issue Reported!',
                successMsg:     'Thank you. The maintenance team has been notified and will address the issue.',
                reportAnother:  'Report Another Issue',
                errorEmpty:     'Please describe the issue before submitting.',
                errorFail:      'Failed to submit. Please try again.',
            },
            zh: {
                loading:        'Ê≠£Âú®Âä†ËΩΩËÆæÂ§á‰ø°ÊÅØ‚Ä¶',
                notFound:       'Êú™ÊâæÂà∞ËÆæÂ§áÔºåËØ∑ÈáçÊñ∞Êâ´Êèè‰∫åÁª¥Á†Å„ÄÇ',
                formTitle:      '‚ö†Ô∏è Êä•ÂëäÈóÆÈ¢ò',
                formSubtitle:   'ËØ∑Ê∏ÖÊ•öÊèèËø∞Ê≠§ËÆæÂ§áÁöÑÈóÆÈ¢ò„ÄÇ',
                labelDesc:      'ÈóÆÈ¢òÊòØ‰ªÄ‰πàÔºü*',
                descPlaceholder:'‰æãÂ¶ÇÔºöÈó®Â∞ÅÊù°ÊçüÂùèÔºåÂÜ∞ÁÆ±Êó†Ê≥ï‰øùÊåÅÊ∏©Â∫¶‚Ä¶',
                labelName:      'ÊÇ®ÁöÑÂßìÂêç',
                labelOptional:  'ÔºàÂèØÈÄâÔºâ',
                namePlaceholder:'‰æãÂ¶ÇÔºöÂ∞èÊòé',
                submitBtn:      'Êèê‰∫§Êä•Âëä',
                submitting:     'Êèê‰∫§‰∏≠‚Ä¶',
                successTitle:   'ÈóÆÈ¢òÂ∑≤Êä•ÂëäÔºÅ',
                successMsg:     'Ë∞¢Ë∞¢ÊÇ®„ÄÇÁª¥‰øÆÂõ¢ÈòüÂ∑≤Êî∂Âà∞ÈÄöÁü•ÔºåÂ∞ÜÂ∞ΩÂø´Â§ÑÁêÜ„ÄÇ',
                reportAnother:  'Êä•ÂëäÂè¶‰∏Ä‰∏™ÈóÆÈ¢ò',
                errorEmpty:     'ËØ∑Âú®Êèê‰∫§ÂâçÊèèËø∞ÈóÆÈ¢ò„ÄÇ',
                errorFail:      'Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ',
            }
        };

        let lang = 'en';
        let equipmentId = null;
        let allEquipmentList = [];

        // Enable Continue button when something is selected
        document.addEventListener('change', function(e) {
            if (e.target.id === 'eqDropdown') {
                document.getElementById('btnSelectEq').disabled = !e.target.value;
            }
        });

        async function selectEquipment() {
            const sel = document.getElementById('eqDropdown');
            const id  = sel.value;
            if (!id) return;
            document.getElementById('selectorArea').style.display = 'none';
            await loadAndShowForm(id);
        }

        function setLang(l) {
            lang = l;
            document.getElementById('btnEN').classList.toggle('active', l === 'en');
            document.getElementById('btnZH').classList.toggle('active', l === 'zh');
            applyTranslations();
        }

        function applyTranslations() {
            const t = translations[lang];
            document.getElementById('loadingBanner').textContent     = t.loading;
            document.getElementById('notFoundText').textContent      = t.notFound;
            document.getElementById('formTitle').textContent         = t.formTitle;
            document.getElementById('formSubtitle').textContent      = t.formSubtitle;
            document.getElementById('labelDescription').textContent  = t.labelDesc;
            document.getElementById('description').placeholder       = t.descPlaceholder;
            document.getElementById('labelName').textContent         = t.labelName;
            document.getElementById('labelOptional').textContent     = t.labelOptional;
            document.getElementById('reportedBy').placeholder        = t.namePlaceholder;
            document.getElementById('successTitle').textContent      = t.successTitle;
            document.getElementById('successMsg').textContent        = t.successMsg;
            document.getElementById('reportAnotherBtn').textContent  = t.reportAnother;
            const btn = document.getElementById('submitBtn');
            if (!btn.disabled) btn.textContent = t.submitBtn;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Auto-detect browser language
            const browserLang = (navigator.language || navigator.userLanguage || '').toLowerCase();
            if (browserLang.startsWith('zh')) setLang('zh');
            else applyTranslations();

            const params = new URLSearchParams(window.location.search);
            equipmentId = params.get('id');

            if (!equipmentId) {
                // No QR scan ‚Äî show dropdown selector
                document.getElementById('loadingBanner').style.display = 'none';
                document.getElementById('selectorArea').style.display = 'block';
                // Load all equipment for dropdown
                try {
                    const res = await fetch(`${API_BASE}/equipment`);
                    if (res.ok) {
                        allEquipmentList = await res.json();
                        const sel = document.getElementById('eqDropdown');
                        // Group by location
                        const groups = {};
                        allEquipmentList.forEach(eq => {
                            const loc = (eq.location && eq.location.trim()) ? eq.location.trim() : 'No Location';
                            if (!groups[loc]) groups[loc] = [];
                            groups[loc].push(eq);
                        });
                        Object.keys(groups).sort((a,b) => a === 'No Location' ? 1 : b === 'No Location' ? -1 : a.localeCompare(b)).forEach(loc => {
                            const grp = document.createElement('optgroup');
                            grp.label = loc;
                            groups[loc].forEach(eq => {
                                const opt = document.createElement('option');
                                opt.value = eq.equipmentId;
                                opt.textContent = eq.name + (eq.type ? ` (${eq.type})` : '');
                                grp.appendChild(opt);
                            });
                            sel.appendChild(grp);
                        });
                    }
                } catch (e) { /* non-critical */ }
                return;
            }

            await loadAndShowForm(equipmentId);
        });

        async function loadAndShowForm(id) {
            equipmentId = id;
            try {
                const res = await fetch(`${API_BASE}/equipment/${id}`);
                if (!res.ok) throw new Error('Not found');
                const eq = await res.json();

                document.getElementById('equipmentIcon').textContent = typeIcons[eq.type] || '‚öôÔ∏è';
                document.getElementById('equipmentName').textContent = eq.name;
                document.getElementById('equipmentMeta').textContent = [eq.type, eq.location].filter(Boolean).join(' ¬∑ ');

                document.getElementById('loadingBanner').style.display = 'none';
                document.getElementById('formArea').style.display = 'block';
            } catch (e) {
                document.getElementById('loadingBanner').style.display = 'none';
                document.getElementById('notFoundBanner').style.display = 'block';
            }
        }

        async function submitReport() {
            const t = translations[lang];
            const description = document.getElementById('description').value.trim();
            const reportedBy  = document.getElementById('reportedBy').value.trim();
            const errorMsg    = document.getElementById('errorMsg');

            if (!description) {
                errorMsg.textContent = t.errorEmpty;
                errorMsg.style.display = 'block';
                return;
            }
            errorMsg.style.display = 'none';

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = t.submitting;

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 30000);

            try {
                const fd = new FormData();
                fd.append('equipmentId', equipmentId);
                fd.append('description', description);
                fd.append('reportedBy',  reportedBy || 'Anonymous');
                const photoFile = document.getElementById('issuePhoto').files[0];
                if (photoFile) fd.append('image', photoFile);

                const res = await fetch(`${API_BASE}/equipment-issues`, {
                    method: 'POST',
                    body: fd,
                    signal: controller.signal
                });

                if (!res.ok) throw new Error('Failed to submit');

                document.getElementById('reportForm').style.display = 'none';
                document.getElementById('successState').style.display = 'block';
            } catch (e) {
                errorMsg.textContent = e.name === 'AbortError'
                    ? 'Request timed out. Please check your connection and try again.'
                    : t.errorFail;
                errorMsg.style.display = 'block';
            } finally {
                clearTimeout(timeout);
                btn.disabled = false;
                btn.textContent = t.submitBtn;
            }
        }

        function handlePhotoSelect(input) {
            const file = input.files[0];
            const preview = document.getElementById('photoPreview');
            const previewImg = document.getElementById('photoPreviewImg');
            const nameEl = document.getElementById('photoFileName');
            const labelEl = document.getElementById('photoLabelText');
            if (file) {
                previewImg.src = URL.createObjectURL(file);
                nameEl.textContent = file.name;
                preview.style.display = 'block';
                labelEl.textContent = '‚úÖ Photo selected ‚Äî tap to change';
            } else {
                preview.style.display = 'none';
                labelEl.textContent = 'Tap to attach a photo';
            }
        }

        function resetForm() {
            const t = translations[lang];
            document.getElementById('description').value = '';
            document.getElementById('reportedBy').value = '';
            document.getElementById('issuePhoto').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoLabelText').textContent = 'Tap to attach a photo';
            document.getElementById('errorMsg').style.display = 'none';
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.textContent = t.submitBtn;
            document.getElementById('reportForm').style.display = 'block';
            document.getElementById('successState').style.display = 'none';
        }
    </script>
  <script src="/js/shell.js"></script>
</body>
</html>
