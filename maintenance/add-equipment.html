<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Equipment - Central Kitchen Maintenance</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            background: linear-gradient(180deg, var(--card), #fffbf9);
            padding: 32px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 6px 18px var(--shadow);
        }

        .form-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .form-header h2 {
            color: var(--accent);
            margin: 0 0 8px 0;
            font-size: 1.8rem;
        }

        .form-header p {
            color: var(--muted);
            margin: 0;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .form-section h3 {
            color: var(--accent-2);
            font-size: 1.2rem;
            margin: 0 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--ink);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group label .required {
            color: var(--accent);
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            background: white;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group small {
            color: var(--muted);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid var(--border);
        }

        .form-actions button {
            padding: 14px 32px;
            font-size: 1rem;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
        }

        .error-message {
            background: linear-gradient(135deg, #fff5f5, #fef2f1);
            color: var(--accent);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #e6fff0, #f0fff6);
            color: var(--success);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid var(--success);
            margin-bottom: 20px;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            background: white;
            padding: 32px 48px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .loading-spinner h3 {
            margin: 16px 0 0 0;
            color: var(--ink);
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .form-container {
                padding: 20px;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/index.html" style="display: inline-flex; text-decoration: none;">
                <img src="assets/Chilli-Api-Logo-170px.png" alt="Central Kitchen Logo" class="site-logo">
            </a>
            <a href="maintenance.html" class="test-button" style="margin-left:18px;align-self:center;">‚Üê Back to Dashboard</a>
            <div class="header-text">
                <h1 id="pageTitle">Add New Equipment</h1>
                <p>Fill in the equipment details below</p>
            </div>
        </div>
    </header>

    <main>
        <div class="form-container">
            <div class="form-header">
                <h2 id="formTitle">Add New Equipment</h2>
                <p id="formSubtitle">Enter all required information marked with *</p>
            </div>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <form id="equipmentForm">
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>üìã Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Equipment Name<span class="required">*</span></label>
                            <input type="text" id="name" name="name" required placeholder="e.g., Walk-in Freezer #1">
                        </div>
                        <div class="form-group">
                            <label for="type">Equipment Type<span class="required">*</span></label>
                            <input type="text" id="type" name="type" required placeholder="e.g., Combi Oven, Deep Fryer, Mixer">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="brand">Brand/Manufacturer</label>
                            <input type="text" id="brand" name="brand" placeholder="e.g., Hoshizaki">
                        </div>
                        <div class="form-group">
                            <label for="modelNumber">Model Number</label>
                            <input type="text" id="modelNumber" name="modelNumber" placeholder="e.g., F-1501">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="serialNumber">Serial Number</label>
                            <input type="text" id="serialNumber" name="serialNumber" placeholder="e.g., SN123456789">
                        </div>
                        <div class="form-group">
                            <label for="location">Location/Area</label>
                            <select id="location" name="location">
                                <option value="">‚Äî Select location ‚Äî</option>
                                <optgroup label="Units">
                                    <option value="#06-27/15/16/17 (Main CK Area)">#06-27/15/16/17 (Main CK Area)</option>
                                    <option value="#06-24 (Raw Prep)">#06-24 (Raw Prep)</option>
                                    <option value="#06-19 (Bakery)">#06-19 (Bakery)</option>
                                    <option value="#06-08 (Dishwashing)">#06-08 (Dishwashing)</option>
                                    <option value="#05-26">#05-26</option>
                                    <option value="#05-27 (Tay Sauce Kitchen)">#05-27 (Tay Sauce Kitchen)</option>
                                    <option value="#04-08 (Confinement)">#04-08 (Confinement)</option>
                                </optgroup>
                                <optgroup label="Main CK Sub-Areas">
                                    <option value="Combi Oven Area">Combi Oven Area</option>
                                    <option value="Deep Frying Area">Deep Frying Area</option>
                                    <option value="Stir Frying Area">Stir Frying Area</option>
                                    <option value="Packing Area">Packing Area</option>
                                    <option value="Salad Room">Salad Room</option>
                                    <option value="Fruit Room">Fruit Room</option>
                                    <option value="Cold Room">Cold Room</option>
                                    <option value="Pan Fry Area">Pan Fry Area</option>
                                    <option value="Braising Area">Braising Area</option>
                                    <option value="Big Store">Big Store</option>
                                    <option value="Small Store">Small Store</option>
                                    <option value="Old Sauce Area">Old Sauce Area</option>
                                    <option value="Office/Changing Room Area">Office/Changing Room Area</option>
                                    <option value="Vegetable Prep Room">Vegetable Prep Room</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="equipmentId">Equipment ID</label>
                            <input type="text" id="equipmentId" name="equipmentId" placeholder="Leave blank to auto-generate">
                            <small>Optional. Use a custom ID like EQ00025.</small>
                        </div>
                        <div class="form-group">
                            <label for="status">Current Status<span class="required">*</span></label>
                            <select id="status" name="status" required>
                                <option value="operational">Operational</option>
                                <option value="needs_action">Needs Action</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Purchase & Warranty -->
                <div class="form-section">
                    <h3>üí∞ Purchase & Warranty Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchaseDate">Purchase Date</label>
                            <input type="text" id="purchaseDate" name="purchaseDate" placeholder="Select date">
                        </div>
                        <div class="form-group">
                            <label for="warrantyExpiry">Warranty Expiry Date</label>
                            <input type="text" id="warrantyExpiry" name="warrantyExpiry" placeholder="Select date">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="installationDate">Installation Date</label>
                            <input type="text" id="installationDate" name="installationDate" placeholder="Select date">
                        </div>
                        <div class="form-group">
                            <label for="expectedLifespan">Expected Lifespan (years)</label>
                            <input type="number" id="expectedLifespan" name="expectedLifespan" min="0" step="1" placeholder="e.g., 10">
                        </div>
                    </div>
                </div>

                <!-- Maintenance Schedule -->
                <div class="form-section">
                    <h3>üîß Maintenance Schedule</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceFrequency">Maintenance Frequency<span class="required">*</span></label>
                            <select id="maintenanceFrequency" name="maintenanceFrequency" required>
                                <option value="">Select Frequency</option>
                                <option value="30">Monthly</option>
                                <option value="365">Yearly</option>
                            </select>
                            <small>How often should this equipment be serviced?</small>
                        </div>
                        <div class="form-group">
                            <label for="lastServiceDate">Last Service Date</label>
                            <input type="text" id="lastServiceDate" name="lastServiceDate" placeholder="Select date">
                            <small>Leave blank if never serviced</small>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <h3>üìù Additional Information</h3>
                    <div class="form-row single">
                        <div class="form-group">
                            <label for="operatingInstructions">Operating Instructions</label>
                            <textarea id="operatingInstructions" name="operatingInstructions" placeholder="Enter operating instructions or procedures..."></textarea>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label for="safetyNotes">Safety Notes</label>
                            <textarea id="safetyNotes" name="safetyNotes" placeholder="Enter safety precautions or warnings..."></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="supplierContact">Supplier Contact</label>
                            <input type="text" id="supplierContact" name="supplierContact" placeholder="Supplier name and contact">
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="cancelForm()">Cancel</button>
                    <button type="submit">üíæ Save Equipment</button>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 Central Kitchen Maintenance System | 
        <a href="maintenance.html">Dashboard</a> | 
        <a href="equipment-list.html">All Equipment</a></p>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <h3>Processing...</h3>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="js/api.js"></script>
    <script>
        let isEditMode = false;
        let equipmentId = null;
        let equipmentIdManuallyEdited = false;

        // Initialize date pickers
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Flatpickr on date fields
            flatpickr("#purchaseDate", { dateFormat: "Y-m-d" });
            flatpickr("#warrantyExpiry", { dateFormat: "Y-m-d" });
            flatpickr("#installationDate", { dateFormat: "Y-m-d" });
            flatpickr("#lastServiceDate", { dateFormat: "Y-m-d" });

            // Check if editing existing equipment
            const urlParams = new URLSearchParams(window.location.search);
            equipmentId = urlParams.get('id');

            if (equipmentId) {
                isEditMode = true;
                document.getElementById('pageTitle').textContent = 'Edit Equipment';
                document.getElementById('formTitle').textContent = 'Edit Equipment';
                document.getElementById('formSubtitle').textContent = 'Update equipment information';
                loadEquipmentData();
            }

            document.getElementById('type').addEventListener('change', handleTypeChange);

            // Auto-copy name to equipmentId when not in edit mode
            const nameInput = document.getElementById('name');
            const equipmentIdInput = document.getElementById('equipmentId');
            nameInput.addEventListener('input', () => {
                if (!isEditMode && !equipmentIdManuallyEdited) {
                    equipmentIdInput.value = nameInput.value;
                }
            });
            equipmentIdInput.addEventListener('input', () => {
                equipmentIdManuallyEdited = equipmentIdInput.value !== nameInput.value && equipmentIdInput.value !== '';
            });

            // Form submission
            document.getElementById('equipmentForm').addEventListener('submit', handleSubmit);
        });



        async function loadEquipmentData() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/equipment/${equipmentId}`);
                if (!response.ok) throw new Error('Failed to load equipment');

                const equipment = await response.json();
                populateForm(equipment);
                hideLoading();
            } catch (error) {
                console.error('Error loading equipment:', error);
                showError('Failed to load equipment data');
                hideLoading();
            }
        }

        function normalizeStatus(value) {
            if (!value) return 'operational';
            return value === 'operational' ? 'operational' : 'needs_action';
        }

        function populateForm(equipment) {
            document.getElementById('name').value = equipment.name || '';
            document.getElementById('type').value = equipment.type || '';
            document.getElementById('brand').value = equipment.brand || '';
            document.getElementById('modelNumber').value = equipment.modelNumber || '';
            document.getElementById('serialNumber').value = equipment.serialNumber || '';
            document.getElementById('location').value = equipment.location || '';
            document.getElementById('equipmentId').value = equipment.equipmentId || '';
            document.getElementById('status').value = normalizeStatus(equipment.status);

            if (equipment.purchaseDate) {
                document.getElementById('purchaseDate').value = equipment.purchaseDate.split('T')[0];
            }
            if (equipment.warrantyExpiry) {
                document.getElementById('warrantyExpiry').value = equipment.warrantyExpiry.split('T')[0];
            }
            if (equipment.installationDate) {
                document.getElementById('installationDate').value = equipment.installationDate.split('T')[0];
            }
            if (equipment.lastServiceDate) {
                document.getElementById('lastServiceDate').value = equipment.lastServiceDate.split('T')[0];
            }

            document.getElementById('expectedLifespan').value = equipment.expectedLifespan || '';
            document.getElementById('maintenanceFrequency').value = equipment.maintenanceFrequency || '';
            document.getElementById('operatingInstructions').value = equipment.operatingInstructions || '';
            document.getElementById('safetyNotes').value = equipment.safetyNotes || '';
            document.getElementById('supplierContact').value = equipment.supplierContact || '';
        }

        async function handleSubmit(event) {
            event.preventDefault();

            // Clear previous messages
            hideError();
            hideSuccess();

            // Gather form data
            const formData = {
                name: document.getElementById('name').value.trim(),
                type: document.getElementById('type').value.trim(),
                brand: document.getElementById('brand').value.trim(),
                modelNumber: document.getElementById('modelNumber').value.trim(),
                serialNumber: document.getElementById('serialNumber').value.trim(),
                location: document.getElementById('location').value.trim(),
                status: document.getElementById('status').value,
                purchaseDate: document.getElementById('purchaseDate').value || null,
                warrantyExpiry: document.getElementById('warrantyExpiry').value || null,
                installationDate: document.getElementById('installationDate').value || null,
                lastServiceDate: document.getElementById('lastServiceDate').value || null,
                expectedLifespan: document.getElementById('expectedLifespan').value ? parseInt(document.getElementById('expectedLifespan').value) : null,
                maintenanceFrequency: parseInt(document.getElementById('maintenanceFrequency').value),
                operatingInstructions: document.getElementById('operatingInstructions').value.trim(),
                safetyNotes: document.getElementById('safetyNotes').value.trim(),
                supplierContact: document.getElementById('supplierContact').value.trim()
            };

            const equipmentIdValue = document.getElementById('equipmentId').value.trim();
            if (equipmentIdValue) {
                formData.equipmentId = equipmentIdValue;
            }

            // Validate required fields
            if (!formData.name || !formData.type || !formData.maintenanceFrequency) {
                showError('Please fill in all required fields marked with *');
                return;
            }

            showLoading();

            try {
                const url = isEditMode ? `${API_BASE}/equipment/${equipmentId}` : `${API_BASE}/equipment`;
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save equipment');
                }

                const result = await response.json();

                hideLoading();
                showSuccess(isEditMode ? 'Equipment updated successfully!' : 'Equipment created successfully!');

                // Redirect after short delay
                setTimeout(() => {
                    if (isEditMode) {
                        window.location.href = `equipment-details.html?id=${result.equipmentId}`;
                    } else {
                        window.location.href = `equipment-details.html?id=${result.equipmentId}`;
                    }
                }, 1500);

            } catch (error) {
                console.error('Error saving equipment:', error);
                hideLoading();
                showError(error.message || 'Failed to save equipment. Please try again.');
            }
        }

        function cancelForm() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                if (isEditMode) {
                    window.location.href = `equipment-details.html?id=${equipmentId}`;
                } else {
                    window.location.href = 'equipment-list.html';
                }
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = '‚úÖ ' + message;
            successDiv.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideSuccess() {
            document.getElementById('successMessage').style.display = 'none';
        }
    </script>
</body>
</html>
