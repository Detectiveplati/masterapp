<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area QR Codes | Central Kitchen</title>
    <link rel="stylesheet" href="/css/app.css">
    <style>
        /* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 28px 20px 60px;
        }

        .section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 22px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-head h2 {
            font-size: 1.15rem;
            font-weight: 800;
            color: var(--text-primary, #121316);
        }

        .section-head p {
            font-size: 0.83rem;
            color: var(--text-muted, #5b5b5b);
            margin-top: 2px;
        }

        .btn-print-all {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #1a252f, #2c3e50);
            color: white;
            border: none;
            border-radius: 9px;
            font-size: 0.87rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .btn-print-all:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }

        /* â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .areas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 22px;
        }

        /* â”€â”€ Area card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .area-card {
            background: white;
            border-radius: 16px;
            border: 1px solid rgba(18,19,22,0.10);
            box-shadow: 0 4px 16px rgba(0,0,0,0.07);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.18s, box-shadow 0.18s;
        }

        .area-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.11);
        }

        .card-header {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            padding: 14px 16px;
        }

        .card-header .en-name {
            font-size: 1rem;
            font-weight: 800;
        }

        .card-header .zh-name {
            font-size: 1.25rem;
            font-weight: 700;
            opacity: 0.90;
            margin-top: 2px;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }

        .card-header .issue-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.20);
            border: 1px solid rgba(255,255,255,0.35);
            border-radius: 20px;
            padding: 2px 9px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 7px;
        }

        .issue-badge.has-issues {
            background: rgba(255,235,59,0.25);
            border-color: rgba(255,235,59,0.5);
        }

        .qr-area {
            padding: 20px;
            text-align: center;
            background: #fafafa;
            border-bottom: 1px solid rgba(18,19,22,0.07);
        }

        .qr-area canvas,
        .qr-area img {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        }

        .qr-loading {
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 0.85rem;
            margin: 0 auto;
        }

        .qr-url {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 8px;
            word-break: break-all;
            padding: 0 4px;
        }

        .card-actions {
            padding: 14px 16px;
            display: flex;
            gap: 8px;
        }

        .btn-download {
            flex: 1;
            padding: 9px 10px;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background 0.15s;
            text-decoration: none;
        }

        .btn-download:hover { background: #e9ecef; }

        .btn-report {
            flex: 1;
            padding: 9px 10px;
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            text-decoration: none;
            transition: transform 0.15s;
        }

        .btn-report:hover { transform: scale(1.04); }

        /* â”€â”€ Section label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .areas-section-label {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.9px;
            color: var(--text-muted, #5b5b5b);
            margin: 28px 0 14px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(18,19,22,0.08);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .areas-section-label .label-count {
            background: rgba(18,19,22,0.08);
            border-radius: 20px;
            padding: 1px 9px;
            font-size: 0.7rem;
        }

        /* â”€â”€ Unit card header override â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card-header.unit {
            background: linear-gradient(135deg, #1a252f, #2c3e50);
        }

        .card-header.unit-bakery   { background: linear-gradient(135deg, #7d3c98, #a569bd); }
        .card-header.unit-rawprep  { background: linear-gradient(135deg, #1a6b3c, #27ae60); }
        .card-header.unit-taysauce { background: linear-gradient(135deg, #b7770d, #f0a500); }
        .card-header.unit-05-26    { background: linear-gradient(135deg, #1a5276, #2980b9); }
        .card-header.unit-confinement { background: linear-gradient(135deg, #6e2f1a, #c0392b); }
        @media print {
            header button,
            .section-head .btn-print-all,
            .card-actions { display: none !important; }

            .area-card { break-inside: avoid; page-break-inside: avoid; }
            body { background: white; }
        }

        @media (max-width: 560px) {
            .areas-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-module="maintenance">



<main>
    <div class="section-head">
        <div>
            <h2>Kitchen Areas &amp; Units</h2>
            <p>Each QR code links directly to the bilingual reporting form for that unit or area</p>
        </div>
        <a href="all-issues.html#area" class="btn-print-all" style="text-decoration:none;">ğŸ“‹ View All Issues â†’</a>
    </div>

    <div class="areas-section-label">ğŸ¢ Units <span class="label-count" id="unitCount">7</span></div>
    <div class="areas-grid" id="unitsGrid"></div>

    <div class="areas-section-label">ğŸ“ Main CK Area â€” Kitchen Zones <span class="label-count">14</span></div>
    <div class="areas-grid" id="areasGrid"></div>
</main>

<script src="js/api.js"></script>
<script>
const MAIN_CK = '#06-27/15/16/17 (Main CK Area)';

const UNITS = [
    { en: MAIN_CK,                        zh: '#06-27/15/16/17ï¼ˆä¸»ä¸­å¤®å¨æˆ¿åŒºï¼‰', icon: 'ğŸ­', headerClass: 'unit' },
    { en: '#06-24 (Raw Prep)',             zh: '#06-24ï¼ˆç”Ÿé£Ÿå‡†å¤‡ï¼‰',             icon: 'ğŸ”ª', headerClass: 'unit-rawprep' },
    { en: '#06-19 (Bakery)',               zh: '#06-19ï¼ˆé¢åŒ…æˆ¿ï¼‰',               icon: 'ğŸ¥–', headerClass: 'unit-bakery' },    { en: '#06-08 (Dishwashing)',           zh: '#06-08ï¼ˆæ´—ç£—é—´ï¼‰',             icon: 'ğŸ½ï¸', headerClass: 'unit-05-26' },    { en: '#05-26',                        zh: '#05-26',                         icon: 'ğŸ¢', headerClass: 'unit-05-26' },
    { en: '#05-27 (Tay Sauce Kitchen)',    zh: '#05-27ï¼ˆæ³°é…±å¨æˆ¿ï¼‰',             icon: 'ğŸœ', headerClass: 'unit-taysauce' },
    { en: '#04-08 (Confinement)',          zh: '#04-08ï¼ˆåæœˆä¸­å¿ƒï¼‰',             icon: 'ğŸ¥', headerClass: 'unit-confinement' }
];

const SUB_AREAS = [
    { en: 'Combi Oven Area',           zh: 'ä¸‡èƒ½çƒ¤ç‚‰åŒº', icon: 'ğŸ”¥' },
    { en: 'Deep Frying Area',          zh: 'ç‚¸é”…åŒº',    icon: 'ğŸ³' },
    { en: 'Stir Frying Area',          zh: 'ç‚’é”…åŒº',    icon: 'ğŸ¥¢' },
    { en: 'Packing Area',              zh: 'åŒ…è£…åŒº',    icon: 'ğŸ“¦' },
    { en: 'Salad Room',                zh: 'æ²™å¾‹æˆ¿',    icon: 'ğŸ¥—' },
    { en: 'Fruit Room',                zh: 'æ°´æœæˆ¿',    icon: 'ğŸ' },
    { en: 'Cold Room',                 zh: 'å†·è—å®¤',    icon: 'â„ï¸' },
    { en: 'Pan Fry Area',              zh: 'ç…é”…åŒº',    icon: 'ğŸ³' },
    { en: 'Braising Area',             zh: 'åœ†ç«åŒº',    icon: 'ğŸ²' },
    { en: 'Big Store',                 zh: 'å¤§ä»“åº“',    icon: 'ğŸ¬' },
    { en: 'Small Store',               zh: 'å°ä»“åº“',    icon: 'ğŸ—„ï¸' },
    { en: 'Old Sauce Area',            zh: 'æ—§é…±æ–™åŒº',  icon: 'ğŸ«™' },
    { en: 'Office/Changing Room Area', zh: 'åŠå…¬å®¤/æŠ¥é•’å®¤', icon: 'ğŸ¢' },
    { en: 'Vegetable Prep Room',        zh: 'è”¬èœå‡†å¤‡å®¤',      icon: 'ğŸ¥¦' }
];

let _publicBase = null;
async function getPublicBase() {
    if (_publicBase) return _publicBase;
    try {
        const res = await fetch(`${API_BASE}/public-url`);
        if (res.ok) { const d = await res.json(); _publicBase = d.url.replace(/\/$/, ''); return _publicBase; }
    } catch (_) {}
    const port = window.location.port;
    _publicBase = (port && port !== '80' && port !== '443')
        ? `${window.location.protocol}//${window.location.hostname}:${port}`
        : `${window.location.protocol}//${window.location.hostname}`;
    return _publicBase;
}

async function buildUrl(params) {
    const base = await getPublicBase();
    const qs   = new URLSearchParams(params).toString();
    const url  = `${base}/area-maintenance.html?${qs}`;
    return base.includes('ngrok') ? `${url}&ngrok-skip-browser-warning=1` : url;
}

function slugify(str) { return str.toLowerCase().replace(/[^a-z0-9]/g, '-'); }

function generateQR(label, url, containerId, downloadId) {
    const qrSrc    = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&margin=6&color=1a252f&bgcolor=ffffff&data=${encodeURIComponent(url)}`;
    const container = document.getElementById(containerId);
    if (!container) return;
    const img = document.createElement('img');
    img.src = qrSrc; img.width = 180; img.height = 180; img.alt = `QR code for ${label}`;
    img.style.borderRadius = '8px'; img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
    img.onerror = () => { container.innerHTML = `<div class="qr-loading" style="color:#e74c3c">QR failed</div>`; };
    const urlLabel = document.createElement('div');
    urlLabel.className = 'qr-url'; urlLabel.textContent = url;
    container.innerHTML = '';
    container.appendChild(img);
    container.appendChild(urlLabel);
    const dlBtn = document.getElementById(downloadId);
    if (dlBtn) { dlBtn.href = qrSrc; dlBtn.target = '_blank'; dlBtn.removeAttribute('download'); }
}

function makeCard(id, item, url, openCount, headerClass) {
    const card = document.createElement('div');
    card.className = 'area-card';
    const slug = slugify(id);
    card.innerHTML = `
        <div class="card-header ${headerClass || ''}">
            <div class="en-name">${item.icon} ${item.en}</div>
            <div class="zh-name">${item.zh}</div>
            <div class="issue-badge ${openCount > 0 ? 'has-issues' : ''}">
                ${openCount > 0 ? 'âš ï¸ ' + openCount + ' open issue' + (openCount > 1 ? 's' : '') : 'âœ… No open issues'}
            </div>
        </div>
        <div class="qr-area" id="qr-${slug}"><div class="qr-loading">Generatingâ€¦</div></div>
        <div class="card-actions">
            <a href="#" class="btn-download" id="dl-${slug}" download="QR-${item.en.replace(/ /g,'-')}.png">â¬‡ï¸ Download</a>
            <a href="${url}" class="btn-report" target="_blank">ğŸ“ Report Issue</a>
        </div>`;
    return { card, slug };
}

async function init() {
    // Fetch issue counts keyed by area value stored in DB
    let issueCounts = {};
    try {
        const res = await fetch(`${API_BASE}/issues?limit=500`);
        if (res.ok) {
            const data = await res.json();
            const list = Array.isArray(data) ? data : (data.issues || data.data || []);
            list.forEach(i => {
                if (i.status === 'Open' || i.status === 'In Progress')
                    issueCounts[i.area] = (issueCounts[i.area] || 0) + 1;
            });
        }
    } catch (_) {}

    const unitsGrid = document.getElementById('unitsGrid');
    const areasGrid = document.getElementById('areasGrid');

    // â”€â”€ Unit cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (const unit of UNITS) {
        const url = await buildUrl({ unit: unit.en });
        const openCount = issueCounts[unit.en] || 0;
        const { card, slug } = makeCard(unit.en, unit, url, openCount, unit.headerClass);
        unitsGrid.appendChild(card);
        generateQR(unit.en, url, `qr-${slug}`, `dl-${slug}`);
    }

    // â”€â”€ Sub-area cards (Main CK zones) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (const area of SUB_AREAS) {
        const url = await buildUrl({ unit: MAIN_CK, area: area.en });
        const openCount = issueCounts[area.en] || 0;
        const { card, slug } = makeCard(area.en, area, url, openCount, '');
        areasGrid.appendChild(card);
        generateQR(area.en, url, `qr-${slug}`, `dl-${slug}`);
    }
}

init();
</script>
  <script src="/js/shell.js"></script>
</body>
</html>
