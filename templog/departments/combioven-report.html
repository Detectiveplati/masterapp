<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <title>Combi Oven Report</title>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    /* ── Page layout ─────────────────────────────────────── */
    .report-wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 12px;
    }
    .report-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 12px 0 6px;
    }
    .report-header img {
      width: 52px;
      height: 52px;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .report-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      line-height: 1.3;
    }
    .report-controls {
      margin: 8px 0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    /* ── Table ───────────────────────────────────────────── */
    #recent-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      table-layout: fixed;
    }
    #recent-table th,
    #recent-table td {
      border: 1px solid #bbb;
      padding: 5px 7px;
      vertical-align: middle;
      word-break: break-word;
    }
    #recent-table thead tr {
      background: #1565c0;
      color: #fff;
    }
    #recent-table thead th {
      border-color: #0d47a1;
      font-weight: 700;
      font-size: 0.7rem;
      text-align: center;
      letter-spacing: 0.02em;
    }
    #recent-table tbody tr:nth-child(even) { background: #f4f7fb; }
    #recent-table tbody tr:nth-child(odd)  { background: #fff; }
    #recent-table tbody td { text-align: center; color: #222; }
    #recent-table tbody td.food-col { text-align: left; }
    /* Column widths */
    .food-col  { width: 22%; }
    .date-col  { width: 10%; white-space: nowrap; }
    .time-col  { width: 8%;  white-space: nowrap; }
    .small-col { width: 8%; }
    /* ── Print-only elements ─────────────────────────────── */
    .print-only { display: none; }
    #print-header { display: none; }
    /* ── Print / PDF ─────────────────────────────────────── */
    body.print .report-controls,
    body.print .no-print         { display: none; }
    body.print #topnav,
    body.print #sidenav          { display: none !important; }
    body.print                   { padding: 0 !important; }
    body.print .print-only       { display: block; }
    body.print #print-header     { display: flex; }
    body.print .report-wrap      { max-width: 100%; padding: 12px 16px; }

    @media print {
      #topnav, #sidenav, #nav-toggle { display: none !important; }
      body { margin: 0 !important; padding: 0 !important; }
      .report-wrap { max-width: 100%; padding: 10px 14px; }
      #print-header { display: flex !important; }
      .report-controls, .no-print { display: none !important; }
      .print-only { display: block !important; }

      #recent-table { font-size: 0.65rem; }
      #recent-table th,
      #recent-table td { padding: 4px 5px; border-color: #999; }
      #recent-table thead tr { background: #1565c0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      #recent-table tbody tr:nth-child(even) { background: #f0f4fa !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body data-module="templog">
<div class="report-wrap">

  <!-- Screen header -->
  <div class="report-header no-print">
    <img src="../assets/Chilli-Api-Logo-170px.png" alt="ChilliApi">
    <h1>组合烤箱报表 Combi Oven Report</h1>
  </div>

  <!-- Print-only header with period -->
  <div id="print-header" style="align-items:center;gap:12px;margin-bottom:8px;">
    <img src="../assets/Chilli-Api-Logo-170px.png" alt="ChilliApi" style="width:44px;height:44px;border-radius:6px;">
    <div>
      <div style="font-size:1.1rem;font-weight:700;">组合烤箱报表 Combi Oven Report</div>
      <div id="report-period" style="font-size:0.75rem;color:#555;margin-top:2px;"></div>
    </div>
  </div>

  <div id="status" class="no-print"></div>

  <div class="report-controls no-print">
    <label for="start-date">Start:</label>
    <input id="start-date" type="date" />
    <label for="end-date">End:</label>
    <input id="end-date" type="date" />
    <button id="pdf-btn" class="export-btn">Download PDF</button>
    <a class="export-btn" href="../index.html">Back</a>
  </div>

  <div id="log">
    <table id="recent-table">
      <thead>
        <tr>
          <th class="food-col">Food Item</th>
          <th class="date-col">Start Date</th>
          <th class="time-col">Start Time</th>
          <th class="time-col">End Time</th>
          <th class="small-col">Duration (min)</th>
          <th class="small-col">Core Temp (°C)</th>
          <th class="small-col">Staff</th>
          <th class="small-col">Numbers</th>
          <th class="small-col">Units</th>
        </tr>
      </thead>
      <tbody id="recent-body"></tbody>
    </table>
  </div>

</div><!-- /.report-wrap -->

  <script>
    window.__reportReady = false;

    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        startDate: params.get('startDate'),
        endDate: params.get('endDate'),
        print: params.get('print') === '1'
      };
    }

    function setPrintMode(isPrint) {
      document.body.classList.toggle('print', isPrint);
    }

    async function loadReport() {
      const statusEl = document.getElementById('status');
      const body = document.getElementById('recent-body');
      const periodEl = document.getElementById('report-period');
      const { startDate, endDate, print } = getQueryParams();

      const qs = [];
      if (startDate) qs.push(`startDate=${encodeURIComponent(startDate)}`);
      if (endDate) qs.push(`endDate=${encodeURIComponent(endDate)}`);
      qs.push('limit=1000');
      const url = `/templog/api/cooks?${qs.join('&')}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to load data');
        const entries = await res.json();

        body.innerHTML = '';
        if (!entries.length) {
          body.innerHTML = '<tr><td colspan="9">No entries found</td></tr>';
          statusEl.textContent = 'No data yet.';
          periodEl.textContent = (startDate || endDate)
            ? `Report period: ${startDate || '...'} to ${endDate || '...'}`
            : 'Report period: All';
          window.__reportReady = true;
          return;
        }

        entries.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="food-col">${entry.food || ''}</td>
            <td class="date-col">${entry.startDate || ''}</td>
            <td class="time-col">${entry.startTime || ''}</td>
            <td class="time-col">${entry.endTime || ''}</td>
            <td class="small-col">${entry.duration || ''}</td>
            <td class="small-col">${entry.temp || ''}</td>
            <td class="small-col">${entry.staff || ''}</td>
            <td class="small-col">${entry.trays || ''}</td>
            <td class="small-col">${entry.units || ''}</td>
          `;
          body.appendChild(row);
        });

        statusEl.textContent = `Loaded ${entries.length} entries.`;
        periodEl.textContent = (startDate || endDate)
          ? `Report period: ${startDate || '...'} to ${endDate || '...'}`
          : 'Report period: All';
        setPrintMode(print);
        window.__reportReady = true;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Failed to load data.';
        window.__reportReady = true;
      }
    }

    // Auto-load when both dates are selected (or clear when both empty)
    function applyDateFilter(autoOnlyBoth = true) {
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;

      // If configured to require both, only apply when both are set
      if (autoOnlyBoth && !start && !end) {
        // nothing selected — clear filters
        const urlClear = new URL(window.location.href);
        urlClear.searchParams.delete('startDate');
        urlClear.searchParams.delete('endDate');
        urlClear.searchParams.delete('print');
        history.replaceState(null, '', urlClear.toString());
        loadReport();
        return;
      }

      if (autoOnlyBoth && (!start || !end)) return; // wait until both are chosen

      const url = new URL(window.location.href);
      url.searchParams.delete('print');
      start ? url.searchParams.set('startDate', start) : url.searchParams.delete('startDate');
      end ? url.searchParams.set('endDate', end) : url.searchParams.delete('endDate');
      history.replaceState(null, '', url.toString());
      loadReport();
    }

    document.getElementById('start-date').addEventListener('change', () => applyDateFilter(true));
    document.getElementById('end-date').addEventListener('change', () => applyDateFilter(true));

    document.getElementById('pdf-btn').addEventListener('click', () => {
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      if (!start && !end) {
        alert('Please choose a start and/or end date first.');
        return;
      }
      // Use browser print dialog — choose "Save as PDF" to export.
      // setPrintMode hides controls and shows print-only elements.
      setPrintMode(true);
      window.print();
      // Restore UI after the print dialog closes.
      window.addEventListener('afterprint', () => setPrintMode(false), { once: true });
    });

    window.addEventListener('load', () => {
      const { startDate, endDate } = getQueryParams();
      if (startDate) document.getElementById('start-date').value = startDate;
      if (endDate) document.getElementById('end-date').value = endDate;
      loadReport();
    });
  </script>

  <script src="/js/shell.js"></script>
</body>
</html>
