<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Kitchen Maintenance Dashboard</title>
    <link rel="stylesheet" href="/css/app.css">
    <style>
        .test-button {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            color: white;
            padding: 11px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            text-decoration: none;
            display: inline-block;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: linear-gradient(180deg, var(--card), #fffbf9);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 6px 18px var(--shadow);
        }
        .chart-card canvas {
            max-height: 300px;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ‚îÄ‚îÄ Immediate Issues section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .issues-live-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 16px;
        }

        @media (max-width: 780px) {
            .issues-live-grid { grid-template-columns: 1fr; }
        }

        .issues-live-col {}

        .issues-live-heading {
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--muted);
            margin: 0 0 10px 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .issues-live-heading .col-count {
            background: linear-gradient(135deg, var(--accent), #e74c3c);
            color: #fff;
            border-radius: 20px;
            padding: 1px 8px;
            font-size: 0.72rem;
            font-weight: 800;
        }

        .issues-live-heading .col-count.orange {
            background: linear-gradient(135deg, var(--accent-2), #e67e22);
        }

        .live-item {
            background: linear-gradient(180deg, #fff, #fffbf9);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 10px;
            padding: 11px 13px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.13s, box-shadow 0.13s;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            box-shadow: 0 2px 8px var(--shadow);
            text-decoration: none;
            color: inherit;
        }

        .live-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .live-item.orange  { border-left-color: var(--accent-2); }
        .live-item.urgent  { border-left-color: #e74c3c; background: linear-gradient(180deg,#fff5f5,#fff); }

        .live-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .live-body { flex: 1; min-width: 0; }

        .live-title {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--ink);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .live-meta {
            font-size: 0.74rem;
            color: var(--muted);
            margin-top: 3px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .live-badge {
            display: inline-block;
            border-radius: 20px;
            padding: 1px 7px;
            font-size: 0.67rem;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            align-self: center;
            margin-left: auto;
        }

        .lb-urgent    { background: #e74c3c; color: #fff; }
        .lb-normal    { background: #9ca3af; color: #fff; }
        .lb-action    { background: linear-gradient(135deg,var(--accent-2),#e67e22); color:#fff; }

        .live-empty {
            text-align: center;
            color: var(--muted);
            font-size: 0.88rem;
            padding: 20px 0;
        }

        .live-view-all {
            display: inline-block;
            margin-top: 4px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            background: linear-gradient(135deg, var(--accent), #e74c3c);
            padding: 9px 18px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(192,57,43,0.2);
            transition: transform 0.13s, box-shadow 0.13s;
        }
        .live-view-all:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(192,57,43,0.3); text-decoration: none; }
        .live-view-all.orange {
            background: linear-gradient(135deg, var(--accent-2), #e67e22);
            box-shadow: 0 3px 10px rgba(211,84,0,0.2);
        }
        .live-view-all.orange:hover { box-shadow: 0 6px 16px rgba(211,84,0,0.3); }
        .live-view-all.dark {
            background: linear-gradient(135deg, #1a252f, #2c3e50);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body data-module="maintenance">

    <main>
        <section id="areaIssuesSection">
            <h2>üìç Area &amp; Facilities Issues <span id="areaIssueBadge" style="font-size:0.75rem;font-weight:700;background:linear-gradient(135deg,var(--accent),#e74c3c);color:#fff;border-radius:20px;padding:2px 10px;vertical-align:middle;margin-left:6px;">‚Ä¶</span></h2>
            <p>Live snapshot of open area and facility reports.</p>
            <div id="areaLiveList" style="margin-top:14px;"><p class="live-empty">Loading‚Ä¶</p></div>
            <div style="margin-top:12px;">
                <a href="all-issues.html#area" class="live-view-all">View all area issues ‚Üí</a>
            </div>
        </section>

        <section id="equipIssuesSection">
            <h2>üîß Equipment Issues <span id="equipIssueBadge" style="font-size:0.75rem;font-weight:700;background:linear-gradient(135deg,var(--accent-2),#e67e22);color:#fff;border-radius:20px;padding:2px 10px;vertical-align:middle;margin-left:6px;">‚Ä¶</span></h2>
            <p>Live snapshot of equipment needing attention right now.</p>
            <div id="equipLiveList" style="margin-top:14px;"><p class="live-empty">Loading‚Ä¶</p></div>
            <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;">
                <a href="all-issues.html#equipment" class="live-view-all orange">View all equipment issues ‚Üí</a>
                <a href="equipment-list.html" class="live-view-all dark">View equipment list ‚Üí</a>
            </div>
        </section>


        
    </main>
    <footer>
        <p>&copy; 2026 Central Kitchen Maintenance System by Zack | 
        <a href="maintenance.html">Dashboard</a> | 
        <a href="equipment-list.html">All Equipment</a> | 
        <a href="all-issues.html">All Issues</a> | 
        <a href="area-maintenance.html">Report Issue</a> | 
        <a href="areas.html">Area QR Codes</a> | 
        <a href="api-test.html">API Test</a></p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/area-issues.js"></script>
    <script>
    // ‚îÄ‚îÄ Live immediate issues loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _pOrder = { Urgent: 0, Normal: 1 };
    const _typeIcons = {
        'Walk-In Freezer':'üßä','Standing Freezer':'üßä',
        'Walk-In Chiller':'‚ùÑÔ∏è','Standing Chiller':'‚ùÑÔ∏è','Warmer':'üî•'
    };

    function _esc(s) {
        if (!s) return '';
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function _days(ds) {
        if (!ds) return '';
        const d = Math.floor((Date.now() - new Date(ds)) / 86400000);
        return d === 0 ? 'Today' : d === 1 ? '1d ago' : `${d}d ago`;
    }

    async function loadImmediateIssues() {
        try {
            const [areaRes, eqRes, openEqRes] = await Promise.all([
                fetch(`${API_BASE}/issues`),
                fetch(`${API_BASE}/equipment`),
                fetch(`${API_BASE}/equipment-issues/all-open`)
            ]);

            // ‚îÄ‚îÄ Area issues ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const allArea = areaRes.ok ? await areaRes.json() : [];
            const openArea = allArea
                .filter(i => i.status === 'Open' || i.status === 'In Progress')
                .sort((a, b) => (_pOrder[a.priority] ?? 3) - (_pOrder[b.priority] ?? 3));

            document.getElementById('areaIssueBadge').textContent = openArea.length;
            document.getElementById('areaIssueBadge').style.background = openArea.length > 0
                ? 'linear-gradient(135deg,var(--accent),#e74c3c)'
                : 'linear-gradient(135deg,var(--success),#2ecc71)';

            const areaList = document.getElementById('areaLiveList');
            if (!openArea.length) {
                areaList.innerHTML = '<p class="live-empty">‚úÖ No open area issues</p>';
            } else {
                areaList.innerHTML = openArea.slice(0, 6).map(i => {
                    const isUrgent = i.priority === 'Urgent';
                    const badgeClass = isUrgent ? 'lb-urgent' : 'lb-normal';
                    return `<a class="live-item${isUrgent ? ' urgent' : ''}" href="issue-details.html?id=${i._id}">
                        <span class="live-icon">${categoryIcon(i.category)}</span>
                        <span class="live-body">
                            <span class="live-title">${_esc(i.title)}</span>
                            <span class="live-meta">
                                <span>üìç ${_esc(i.area)}</span>
                                <span>üë§ ${_esc(i.reportedBy)}</span>
                                <span>${_days(i.reportedDate)}</span>
                            </span>
                        </span>
                        ${i.photos && i.photos.length ? `<img src="${i.photos[0]}" alt="" style="width:44px;height:44px;object-fit:cover;border-radius:8px;border:1px solid var(--border);flex-shrink:0;">` : ''}
                        <span class="live-badge ${badgeClass}">${isUrgent ? '! Urgent' : i.priority}</span>
                    </a>`;
                }).join('');
            }

            // ‚îÄ‚îÄ Equipment issues ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const allEq = eqRes.ok ? await eqRes.json() : [];
            const openEq = openEqRes.ok ? await openEqRes.json() : [];
            const needsAction = allEq.filter(e => e.status !== 'operational');
            const eqMap = {};
            allEq.forEach(e => { eqMap[e.equipmentId] = e; });

            const equipTotal = openEq.length + needsAction.length;
            document.getElementById('equipIssueBadge').textContent = equipTotal;
            document.getElementById('equipIssueBadge').style.background = equipTotal > 0
                ? 'linear-gradient(135deg,var(--accent-2),#e67e22)'
                : 'linear-gradient(135deg,var(--success),#2ecc71)';

            const equipList = document.getElementById('equipLiveList');
            if (!equipTotal) {
                equipList.innerHTML = '<p class="live-empty">‚úÖ All equipment operational</p>';
            } else {
                // Merge: staff issues first, then needs-action machines
                const combined = [
                    ...openEq.map(issue => ({
                        _type: 'issue',
                        icon: (eqMap[issue.equipmentId] ? (_typeIcons[eqMap[issue.equipmentId].type] || '‚öôÔ∏è') : '‚öôÔ∏è'),
                        title: eqMap[issue.equipmentId] ? eqMap[issue.equipmentId].name : issue.equipmentId,
                        sub: _esc(issue.description),
                        meta: `üë§ ${_esc(issue.reportedBy || 'Anonymous')} ¬∑ ${_days(issue.reportedDate)}`,
                        href: `equipment-details.html?id=${encodeURIComponent(issue.equipmentId)}`,
                        badge: 'Open Issue', badgeClass: 'lb-urgent'
                    })),
                    ...needsAction.map(eq => ({
                        _type: 'equipment',
                        icon: _typeIcons[eq.type] || '‚öôÔ∏è',
                        title: eq.name,
                        sub: `${_esc(eq.type)} ¬∑ ${_esc(eq.location)}`,
                        meta: '',
                        href: `equipment-details.html?id=${encodeURIComponent(eq.equipmentId)}`,
                        badge: 'Needs Action', badgeClass: 'lb-action'
                    }))
                ];

                equipList.innerHTML = combined.slice(0, 6).map(item => `
                    <a class="live-item orange" href="${item.href}">
                        <span class="live-icon">${item.icon}</span>
                        <span class="live-body">
                            <span class="live-title">${_esc(item.title)}</span>
                            <span class="live-meta">${item.sub}${item.meta ? ' ¬∑ ' + item.meta : ''}</span>
                        </span>
                        <span class="live-badge ${item.badgeClass}">${item.badge}</span>
                    </a>`).join('');
            }


        } catch (err) {
            console.error('Failed to load immediate issues', err);
            document.getElementById('areaLiveList').innerHTML  = '<p class="live-empty" style="color:var(--accent)">‚ö†Ô∏è Could not load</p>';
            document.getElementById('equipLiveList').innerHTML = '<p class="live-empty" style="color:var(--accent)">‚ö†Ô∏è Could not load</p>';
            document.getElementById('areaIssueBadge').textContent = '!';
            document.getElementById('equipIssueBadge').textContent = '!';
        }
    }

    loadImmediateIssues();
    </script>
    <script src="js/charts.js"></script>
    <script src="js/app.js"></script>
    <script src="js/equipment.js"></script>
    <script src="js/records.js"></script>
  <script src="/js/shell.js"></script>
</body>
</html>