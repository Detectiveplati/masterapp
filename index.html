<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Kitchen Maintenance Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-button {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            color: white;
            padding: 11px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            text-decoration: none;
            display: inline-block;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: linear-gradient(180deg, var(--card), #fffbf9);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 6px 18px var(--shadow);
        }
        .chart-card canvas {
            max-height: 300px;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ‚îÄ‚îÄ Immediate Issues section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .issues-live-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 16px;
        }

        @media (max-width: 780px) {
            .issues-live-grid { grid-template-columns: 1fr; }
        }

        .issues-live-col {}

        .issues-live-heading {
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--muted);
            margin: 0 0 10px 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .issues-live-heading .col-count {
            background: linear-gradient(135deg, var(--accent), #e74c3c);
            color: #fff;
            border-radius: 20px;
            padding: 1px 8px;
            font-size: 0.72rem;
            font-weight: 800;
        }

        .issues-live-heading .col-count.orange {
            background: linear-gradient(135deg, var(--accent-2), #e67e22);
        }

        .live-item {
            background: linear-gradient(180deg, #fff, #fffbf9);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 10px;
            padding: 11px 13px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.13s, box-shadow 0.13s;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            box-shadow: 0 2px 8px var(--shadow);
            text-decoration: none;
            color: inherit;
        }

        .live-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .live-item.orange  { border-left-color: var(--accent-2); }
        .live-item.critical { border-left-color: #7f1d1d; background: linear-gradient(180deg,#fff5f5,#fff); }

        .live-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .live-body { flex: 1; min-width: 0; }

        .live-title {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--ink);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .live-meta {
            font-size: 0.74rem;
            color: var(--muted);
            margin-top: 3px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .live-badge {
            display: inline-block;
            border-radius: 20px;
            padding: 1px 7px;
            font-size: 0.67rem;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            align-self: center;
            margin-left: auto;
        }

        .lb-critical  { background: #7f1d1d; color: #fff; }
        .lb-high      { background: #e74c3c; color: #fff; }
        .lb-medium    { background: var(--accent-2); color: #fff; }
        .lb-low       { background: #9ca3af; color: #fff; }
        .lb-action    { background: linear-gradient(135deg,var(--accent-2),#e67e22); color:#fff; }

        .live-empty {
            text-align: center;
            color: var(--muted);
            font-size: 0.88rem;
            padding: 20px 0;
        }

        .live-view-all {
            display: inline-block;
            margin-top: 4px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
        }
        .live-view-all:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" style="display: inline-flex; text-decoration: none;">
                <img src="assets/Chilli-Api-Logo-170px.png" alt="Central Kitchen Logo" class="site-logo">
            </a>
            <div class="header-text">
                <h1>Central Kitchen Maintenance Dashboard</h1>
                <p>Equipment tracking and maintenance management system</p>
            </div>
        </div>
        <div style="display:inline-flex;gap:10px;align-items:center;">
            <a href="/templog/" class="test-button" style="background:linear-gradient(135deg,#3aa6ff,#0e7fd6);">üå° Temp Log</a>
            <a href="api-test.html" class="test-button">üß™ API Test Page</a>
        </div>
    </header>
    <main>
        <section id="immediateIssuesSection">
            <h2 id="immediateIssuesHeading">‚ö†Ô∏è Immediate Issues <span id="immediateTotalBadge" style="font-size:0.75rem;font-weight:700;background:linear-gradient(135deg,var(--accent),#e74c3c);color:#fff;border-radius:20px;padding:2px 10px;vertical-align:middle;margin-left:6px;">‚Ä¶</span></h2>
            <p>Live snapshot of open area reports and equipment needing attention right now.</p>

            <div class="issues-live-grid">
                <!-- Area & Facilities column -->
                <div class="issues-live-col">
                    <div class="issues-live-heading">
                        üìç Area &amp; Facilities
                        <span class="col-count" id="areaIssueCount">‚Ä¶</span>
                    </div>
                    <div id="areaLiveList"><p class="live-empty">Loading‚Ä¶</p></div>
                    <a href="all-issues.html#area" class="live-view-all">View all area issues ‚Üí</a>
                </div>

                <!-- Equipment column -->
                <div class="issues-live-col">
                    <div class="issues-live-heading">
                        üîß Equipment
                        <span class="col-count orange" id="equipIssueCount">‚Ä¶</span>
                    </div>
                    <div id="equipLiveList"><p class="live-empty">Loading‚Ä¶</p></div>
                    <a href="all-issues.html#equipment" class="live-view-all">View all equipment issues ‚Üí</a>
                </div>
            </div>
        </section>

        <section>
            <h2>Equipment Overview</h2>
            <p>Manage statuses and maintenance details on the equipment list page.</p>
            <a href="equipment-list.html" style="text-decoration: none;">
                <button class="btn-secondary">View Equipment List ‚Üí</button>
            </a>
        </section>

        <section>
            <h2>‚ö†Ô∏è All Issues</h2>
            <p>Combined view of area &amp; facility reports and equipment issues ‚Äî filterable, searchable, with priority and status tracking.</p>
            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
                <a href="all-issues.html#area" style="text-decoration:none;">
                    <button style="background:linear-gradient(135deg,#c0392b,#e74c3c);">üìç Area &amp; Facilities ‚Üí</button>
                </a>
                <a href="all-issues.html#equipment" style="text-decoration:none;">
                    <button style="background:linear-gradient(135deg,var(--accent-2),#e67e22);">üîß Equipment Issues ‚Üí</button>
                </a>
                <a href="area-maintenance.html" style="text-decoration:none;">
                    <button style="background:linear-gradient(135deg,#7f8c8d,#95a5a6);">‚ûï Report Area Issue</button>
                </a>
                <a href="areas.html" style="text-decoration:none;">
                    <button style="background:linear-gradient(135deg,#1a252f,#2c3e50);">üìç Area QR Codes</button>
                </a>
            </div>
        </section>
        
    </main>
    <footer>
        <p>&copy; 2026 Central Kitchen Maintenance System by Zack | 
        <a href="index.html">Dashboard</a> | 
        <a href="equipment-list.html">All Equipment</a> | 
        <a href="all-issues.html">All Issues</a> | 
        <a href="area-maintenance.html">Report Issue</a> | 
        <a href="areas.html">Area QR Codes</a> | 
        <a href="api-test.html">API Test</a></p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/area-issues.js"></script>
    <script>
    // ‚îÄ‚îÄ Live immediate issues loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _pOrder = { Critical: 0, High: 1, Medium: 2, Low: 3 };
    const _typeIcons = {
        'Walk-In Freezer':'üßä','Standing Freezer':'üßä',
        'Walk-In Chiller':'‚ùÑÔ∏è','Standing Chiller':'‚ùÑÔ∏è','Warmer':'üî•'
    };

    function _esc(s) {
        if (!s) return '';
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function _days(ds) {
        if (!ds) return '';
        const d = Math.floor((Date.now() - new Date(ds)) / 86400000);
        return d === 0 ? 'Today' : d === 1 ? '1d ago' : `${d}d ago`;
    }

    async function loadImmediateIssues() {
        try {
            const [areaRes, eqRes, openEqRes] = await Promise.all([
                fetch(`${API_BASE}/issues`),
                fetch(`${API_BASE}/equipment`),
                fetch(`${API_BASE}/equipment-issues/all-open`)
            ]);

            // ‚îÄ‚îÄ Area issues ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const allArea = areaRes.ok ? await areaRes.json() : [];
            const openArea = allArea
                .filter(i => i.status === 'Open' || i.status === 'In Progress')
                .sort((a, b) => (_pOrder[a.priority] ?? 3) - (_pOrder[b.priority] ?? 3));

            document.getElementById('areaIssueCount').textContent = openArea.length;

            const areaList = document.getElementById('areaLiveList');
            if (!openArea.length) {
                areaList.innerHTML = '<p class="live-empty">‚úÖ No open area issues</p>';
            } else {
                areaList.innerHTML = openArea.slice(0, 6).map(i => {
                    const isCrit = i.priority === 'Critical';
                    const badgeClass = { Critical:'lb-critical', High:'lb-high', Medium:'lb-medium', Low:'lb-low' }[i.priority] || 'lb-low';
                    return `<a class="live-item${isCrit ? ' critical' : ''}" href="issue-details.html?id=${i._id}">
                        <span class="live-icon">${categoryIcon(i.category)}</span>
                        <span class="live-body">
                            <span class="live-title">${_esc(i.title)}</span>
                            <span class="live-meta">
                                <span>üìç ${_esc(i.area)}</span>
                                <span>üë§ ${_esc(i.reportedBy)}</span>
                                <span>${_days(i.reportedDate)}</span>
                            </span>
                        </span>
                        <span class="live-badge ${badgeClass}">${i.priority}</span>
                    </a>`;
                }).join('');
            }

            // ‚îÄ‚îÄ Equipment issues ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const allEq = eqRes.ok ? await eqRes.json() : [];
            const openEq = openEqRes.ok ? await openEqRes.json() : [];
            const needsAction = allEq.filter(e => e.status !== 'operational');
            const eqMap = {};
            allEq.forEach(e => { eqMap[e.equipmentId] = e; });

            const equipTotal = openEq.length + needsAction.length;
            document.getElementById('equipIssueCount').textContent = equipTotal;

            const equipList = document.getElementById('equipLiveList');
            if (!equipTotal) {
                equipList.innerHTML = '<p class="live-empty">‚úÖ All equipment operational</p>';
            } else {
                // Merge: staff issues first, then needs-action machines
                const combined = [
                    ...openEq.map(issue => ({
                        _type: 'issue',
                        icon: (eqMap[issue.equipmentId] ? (_typeIcons[eqMap[issue.equipmentId].type] || '‚öôÔ∏è') : '‚öôÔ∏è'),
                        title: eqMap[issue.equipmentId] ? eqMap[issue.equipmentId].name : issue.equipmentId,
                        sub: _esc(issue.description),
                        meta: `üë§ ${_esc(issue.reportedBy || 'Anonymous')} ¬∑ ${_days(issue.reportedDate)}`,
                        href: `equipment-details.html?id=${encodeURIComponent(issue.equipmentId)}`,
                        badge: 'Open Issue', badgeClass: 'lb-high'
                    })),
                    ...needsAction.map(eq => ({
                        _type: 'equipment',
                        icon: _typeIcons[eq.type] || '‚öôÔ∏è',
                        title: eq.name,
                        sub: `${_esc(eq.type)} ¬∑ ${_esc(eq.location)}`,
                        meta: '',
                        href: `equipment-details.html?id=${encodeURIComponent(eq.equipmentId)}`,
                        badge: 'Needs Action', badgeClass: 'lb-action'
                    }))
                ];

                equipList.innerHTML = combined.slice(0, 6).map(item => `
                    <a class="live-item orange" href="${item.href}">
                        <span class="live-icon">${item.icon}</span>
                        <span class="live-body">
                            <span class="live-title">${_esc(item.title)}</span>
                            <span class="live-meta">${item.sub}${item.meta ? ' ¬∑ ' + item.meta : ''}</span>
                        </span>
                        <span class="live-badge ${item.badgeClass}">${item.badge}</span>
                    </a>`).join('');
            }

            // ‚îÄ‚îÄ Update section heading total ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const total = openArea.length + equipTotal;
            const badge = document.getElementById('immediateTotalBadge');
            badge.textContent = total;
            badge.style.background = total > 0
                ? 'linear-gradient(135deg,var(--accent),#e74c3c)'
                : 'linear-gradient(135deg,var(--success),#2ecc71)';
            if (!total) {
                document.getElementById('immediateIssuesHeading').childNodes[0].textContent = '‚úÖ All Clear ';
            }

        } catch (err) {
            console.error('Failed to load immediate issues', err);
            document.getElementById('areaLiveList').innerHTML  = '<p class="live-empty" style="color:var(--accent)">‚ö†Ô∏è Could not load</p>';
            document.getElementById('equipLiveList').innerHTML = '<p class="live-empty" style="color:var(--accent)">‚ö†Ô∏è Could not load</p>';
        }
    }

    loadImmediateIssues();
    </script>
    <script src="js/charts.js"></script>
    <script src="js/app.js"></script>
    <script src="js/equipment.js"></script>
    <script src="js/records.js"></script>
</body>
</html>