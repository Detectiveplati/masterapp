<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store">
  <title>Central Kitchen — Hub</title>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 62px);
      padding: 48px 24px 64px;
    }
  </style>
</head>
<body data-module="hub">
  <main>
    <div class="hub-title">Where would you like to go?</div>
    <div class="hub-subtitle" id="hubSubtitle">Select a module below to get started.</div>
    <div id="accessBanner" class="access-banner">
      🔒 You don't have permission for that module. Contact your administrator to request access.
    </div>
    <div class="hub-grid">
      <a href="/maintenance/maintenance.html" class="hub-card maintenance" data-perm="maintenance">
        <div class="icon">🔧</div>
        <h2>Maintenance Dashboard</h2>
        <p>Track equipment status, log service records, report issues, and manage maintenance schedules across all kitchen equipment.</p>
        <div class="lock-note">🔒 No access — contact administrator</div>
        <div class="go-btn">Open Maintenance</div>
      </a>
      <a href="/templog/" class="hub-card templog" data-perm="templog">
        <div class="icon">🌡️</div>
        <h2>Kitchen Temp Log</h2>
        <p>Record cooking activities, monitor temperatures, track cook times, and export logs for compliance reporting.</p>
        <div class="lock-note">🔒 No access — contact administrator</div>
        <div class="go-btn">Open Temp Log</div>
      </a>
      <a href="/procurement/" class="hub-card procurement" data-perm="procurement">
        <div class="icon">🛒</div>
        <h2>Procurement</h2>
        <p>Submit and track purchase requests, attach photos, manage approvals, and keep a full history of all procurement activity.</p>
        <div class="lock-note">🔒 No access — contact administrator</div>
        <div class="go-btn">Open Procurement</div>
      </a>
      <a href="/foodsafety/" class="hub-card foodsafety" data-perm="foodsafety">
        <div class="icon">🍽️</div>
        <h2>Food Safety NC</h2>
        <p>Log and resolve food safety non-conformance instances across all kitchen units. Track open issues and log resolutions.</p>
        <div class="lock-note">🔒 No access — contact administrator</div>
        <div class="go-btn">Open Food Safety</div>
      </a>
      <a href="/pest/" class="hub-card" data-perm="pest" style="--card-accent:#2e7d32;--card-glow:rgba(46,125,50,0.15)">
        <div class="icon">🐭</div>
        <h2>Pest Control</h2>
        <p>Record rat trap surveillance findings, track cockroach sightings, upload photo evidence and view weekly inspection reports.</p>
        <div class="lock-note">🔒 No access — contact administrator</div>
        <div class="go-btn">Open Pest Control</div>
      </a>
      <a href="/admin/" class="hub-card admin" data-perm="__admin__" style="display:none">
        <div class="icon">🔐</div>
        <h2>Admin &amp; User Management</h2>
        <p>Manage user accounts, reset passwords, and control module access permissions for all staff members.</p>
        <div class="go-btn">Open Admin Panel</div>
      </a>
    </div>
    <div class="status-bar">
      <span class="status-dot"></span>
      <span id="statusText">Checking server…</span>
    </div>
  </main>


  <script src="/js/shell.js"></script>
  <script>
    async function initHub() {
      try {
        const r = await fetch('/api/auth/me', { credentials: 'include' });
        if (!r.ok) { window.location.replace('/login'); return; }
        const { user } = await r.json();

        // Cache for shell.js
        window._authUser = user;

        document.getElementById('hubSubtitle').textContent =
          'Welcome back, ' + (user.displayName || user.username) + '. Select a module below.';

        const isAdmin = user.role === 'admin';
        document.querySelectorAll('.hub-card[data-perm]').forEach(function (card) {
          var perm = card.dataset.perm;
          if (perm === '__admin__') {
            card.style.display = isAdmin ? '' : 'none';
          } else if (!isAdmin && !(user.permissions && user.permissions[perm])) {
            card.classList.add('locked');
            card.removeAttribute('href');
          }
        });

        if (new URLSearchParams(window.location.search).get('access') === 'denied') {
          document.getElementById('accessBanner').style.display = 'block';
        }

        document.documentElement.style.visibility = '';
      } catch (e) {
        window.location.replace('/login');
      }
    }

    fetch('/api/health')
      .then(function (r) { return r.json(); })
      .then(function (d) {
        var el  = document.getElementById('statusText');
        var dot = document.querySelector('.status-dot');
        var both = d.maintenance_db === 'Connected' && d.templog_db === 'Connected' && d.procurement_db === 'Connected';
        if (both) {
          el.textContent = 'All systems online  all databases connected';
        } else {
          el.textContent = 'Partial connection  check server logs';
          dot.style.background = '#f39c12';
        }
      })
      .catch(function () {
        document.getElementById('statusText').textContent = 'Server unreachable';
        document.querySelector('.status-dot').style.background = '#e74c3c';
      });

    // Hide until auth confirmed
    document.documentElement.style.visibility = 'hidden';
    initHub();
  </script>
</body>
</html>
