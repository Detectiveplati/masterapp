<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NC Detail - Central Kitchen</title>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    .form-container {
      max-width: 920px;
      margin: 0 auto;
      background: linear-gradient(180deg, var(--card), #fffbf9);
      padding: 32px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 18px var(--shadow);
    }
    .form-header { margin-bottom: 26px; padding-bottom: 18px; border-bottom: 2px solid var(--border); }
    .form-header h2 { color: var(--accent); margin: 0 0 8px 0; font-size: 1.8rem; }
    .form-header p { color: var(--muted); margin: 0; }

    /* NC detail summary grid */
    .summary-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px; margin-bottom: 24px;
    }
    .summary-item { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; }
    .summary-label { font-size: 0.8rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
    .summary-value { font-weight: 700; color: var(--ink); font-size: 1rem; word-break: break-word; }
    .description-block {
      background: white; border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; margin-bottom: 24px;
    }
    .description-block p { margin: 8px 0 0 0; color: var(--ink); line-height: 1.65; }
    .nc-photo img { max-width: 100%; max-height: 260px; border-radius: 8px; border: 1px solid var(--border); object-fit: cover; margin-top: 10px; }

    /* Resolution form */
    .resolution-section {
      margin-top: 32px; padding-top: 28px; border-top: 2px solid var(--border);
    }
    .resolution-section h3 { color: var(--accent); margin: 0 0 20px 0; font-size: 1.4rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-row.single { grid-template-columns: 1fr; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { color: var(--ink); font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
    .form-group label .required { color: var(--accent); margin-left: 4px; }
    .form-group input, .form-group select, .form-group textarea {
      padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 15px; font-family: inherit; background: white; transition: all 0.2s ease;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(192,57,43,0.1);
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-actions {
      display: flex; gap: 12px; justify-content: flex-end;
      margin-top: 26px; padding-top: 20px; border-top: 2px solid var(--border);
    }
    .form-actions button, .form-actions a { padding: 12px 26px; font-size: 1rem; }
    .notice {
      padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border);
      background: #fff; margin-bottom: 20px; display: none;
    }
    .notice.success { border-color: rgba(39,174,96,0.4); background: rgba(39,174,96,0.08); color: #1f7a4a; }
    .notice.error   { border-color: rgba(192,57,43,0.4);  background: rgba(192,57,43,0.08);  color: #b03224; }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-2), #e67e22);
      color: #fff; border: none; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; font-weight: 600;
      text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #7f8c8d, #95a5a6);
      color: white; border: none; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; font-weight: 600;
      text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .photo-upload-label {
      display: flex; align-items: center; gap: 10px; padding: 13px 16px;
      border: 1.5px dashed var(--border); border-radius: 8px; background: white;
      cursor: pointer; font-size: 0.92rem; color: var(--muted); font-weight: 500;
      transition: border-color 0.15s, background 0.15s;
    }
    .photo-upload-label:hover { border-color: var(--accent); background: #fff8f6; color: var(--accent); }
    .photo-upload-label input { display: none; }
    .photo-preview { margin-top: 8px; display: none; }
    .photo-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border); object-fit: cover; }
    .photo-name { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 0.82rem; font-weight: 700; letter-spacing: 0.03em;
    }
    .badge-open     { background: rgba(192,57,43,0.12); color: #b03224; }
    .badge-resolved { background: rgba(39,174,96,0.12); color: #1f7a4a; }
    .badge-urgent   { background: rgba(231,76,60,0.15);  color: #c0392b; }

    /* Photo log */
    .photo-log {
      margin-top: 24px; margin-bottom: 8px;
      border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden; background: white;
    }
    .photo-log-header {
      display: flex; align-items: center; gap: 10px;
      padding: 13px 18px; background: #fafafa;
      border-bottom: 1px solid var(--border);
      font-weight: 700; font-size: 0.95rem; color: var(--ink);
    }
    .photo-log-empty {
      padding: 28px; text-align: center; color: var(--muted);
      font-size: 0.9rem;
    }
    .photo-log-entries { display: flex; flex-wrap: wrap; gap: 0; }
    .photo-log-entry {
      flex: 1 1 260px; padding: 18px;
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 10px;
    }
    .photo-log-entry:last-child { border-right: none; }
    .photo-log-meta {
      display: flex; flex-direction: column; gap: 3px;
    }
    .photo-log-tag {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.06em; border-radius: 6px; padding: 3px 9px;
      width: fit-content;
    }
    .photo-log-tag.report   { background: rgba(192,57,43,0.1);  color: #b03224; }
    .photo-log-tag.resolved { background: rgba(39,174,96,0.1);  color: #1f7a4a; }
    .photo-log-who  { font-size: 0.82rem; color: var(--muted); }
    .photo-log-when { font-size: 0.78rem; color: var(--muted); }
    .photo-log-img {
      width: 100%; max-height: 240px; object-fit: cover;
      border-radius: 8px; border: 1px solid var(--border);
      cursor: pointer; transition: opacity 0.15s;
    }
    .photo-log-img:hover { opacity: 0.88; }

    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .summary-grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body data-module="foodsafety">


  <main>
    <div class="form-container">
      <div class="form-header">
        <h2 id="detailTitle">Loading NC...</h2>
        <p id="detailSubtitle">&nbsp;</p>
      </div>

      <div id="notice" class="notice"></div>

      <!-- NC detail populated by JS -->
      <div id="ncDetail"></div>

      <!-- Photo log populated by JS -->
      <div id="photoLog"></div>

      <!-- Resolution form (shown only when status is Open) -->
      <div id="resolutionSection" class="resolution-section" style="display:none;">
        <h3>Log Resolution</h3>
        <form id="resolutionForm" novalidate>
          <div class="form-row">
            <div class="form-group">
              <label for="resolver">Resolved By <span class="required">*</span></label>
              <input type="text" id="resolver" name="resolver" placeholder="Enter your name" required>
            </div>
            <div class="form-group">
              <label>Resolution Photo <span style="font-weight:400;color:var(--muted)">(optional)</span></label>
              <label class="photo-upload-label" for="resolutionPhotoInput">
                <span>üì∏</span>
                <span id="resPhotoLabelText">Attach a resolution photo</span>
                <input type="file" id="resolutionPhotoInput" name="resolutionPhoto" accept="image/*" onchange="handleResPhotoSelect(this)">
              </label>
              <div class="photo-preview" id="resPhotoPreview">
                <img id="resPhotoPreviewImg" src="" alt="Preview">
                <div class="photo-name" id="resPhotoFileName"></div>
              </div>
            </div>
          </div>
          <div class="form-row single">
            <div class="form-group">
              <label for="resolutionNotes">Resolution Notes <span class="required">*</span></label>
              <textarea id="resolutionNotes" name="resolutionNotes" placeholder="Describe how this NC was resolved..." required></textarea>
            </div>
          </div>
          <div class="form-actions">
            <a href="nc-list.html" class="btn-secondary" style="text-decoration:none;">‚Üê Back to List</a>
            <button type="button" id="deleteBtn" onclick="deleteCurrentNC()" style="background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff;border:none;border-radius:10px;padding:12px 22px;font-size:1rem;font-weight:700;cursor:pointer;">üóë Delete Report</button>
            <button type="submit" class="btn-primary">‚úî Mark as Resolved</button>
          </div>
        </form>
      </div>

      <!-- Already-resolved back button -->
      <div id="resolvedActions" class="form-actions" style="display:none;">
        <a href="nc-list.html" class="btn-secondary" style="text-decoration:none;">‚Üê Back to List</a>
        <button type="button" onclick="deleteCurrentNC()" style="background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff;border:none;border-radius:10px;padding:12px 22px;font-size:1rem;font-weight:700;cursor:pointer;">üóë Delete Report</button>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2026 Central Kitchen | <a href="index.html">Food Safety NC</a> | <a href="/maintenance/maintenance.html">Maintenance</a></p>
  </footer>
  <script src="js/foodsafety-nc.js"></script>
  <script>
    async function deleteCurrentNC() {
      const id = new URLSearchParams(window.location.search).get('id');
      if (!id) return;
      if (!confirm('Delete this NC? This cannot be undone.')) return;
      try {
        const r = await fetch('/api/foodsafety/' + id, { method: 'DELETE' });
        if (!r.ok) throw new Error('Delete failed');
        window.location.replace('nc-list.html');
      } catch (err) { alert('Error: ' + err.message); }
    }

    function handleResPhotoSelect(input) {
      const file = input.files[0];
      const preview = document.getElementById('resPhotoPreview');
      const previewImg = document.getElementById('resPhotoPreviewImg');
      const nameEl = document.getElementById('resPhotoFileName');
      const labelEl = document.getElementById('resPhotoLabelText');
      if (file) {
        previewImg.src = URL.createObjectURL(file);
        nameEl.textContent = file.name;
        preview.style.display = 'block';
        labelEl.textContent = '‚úÖ Photo selected ‚Äî click to change';
      } else {
        preview.style.display = 'none';
        labelEl.textContent = 'Attach a resolution photo';
      }
    }
  </script>
  <script src="/js/shell.js"></script>
</body>
</html>