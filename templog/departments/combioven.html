<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script>document.documentElement.style.visibility='hidden'</script><script src="/auth-guard.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="../manifest.json">
  <title>Combi Oven Kitchen Log - Multi Cook</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .bt-panel {
      margin: 10px 0 20px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .bt-status {
      color: #555;
      font-size: 0.95rem;
      flex: 1;
      min-width: 200px;
    }
    .bt-temp {
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.4rem;
      min-width: 90px;
      text-align: center;
    }
    .bt-target-row {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #888;
      padding-top: 4px;
      border-top: 1px solid #f0f0f0;
    }
    .bt-target-row span { font-weight: 700; color: #d32f2f; }
  </style>
</head>
<body>

  <div style="margin-bottom:12px;">
    <a href="../index.html" style="font-size:0.82rem;font-weight:700;color:#5a616c;text-decoration:none;display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:8px;border:1px solid rgba(18,19,22,0.1);background:#fff;">← 厨房日志 Kitchen Logs</a>
  </div>

  <img src="../assets/Chilli-Api-Logo-170px.png" alt="ChilliApi" style="width:64px;height:64px;float:left;margin-right:12px;border-radius:6px;">
  <h1>组合烤箱部门 Combi Oven Kitchen Log</h1>

  <!-- Bluetooth Thermometer Panel -->
  <div class="bt-panel">
    <button id="bt-connect" class="export-btn">🌡️ 连接温度计 Connect Thermometer</button>
    <button id="bt-read" class="export-btn" disabled>📖 读取温度 Read Temp</button>
    <span id="bt-temp" class="bt-temp"></span>
    <span id="bt-status" class="bt-status">未连接 Not connected</span>
    <div class="bt-target-row">
      🎯 目标 Target: <span id="bt-target-label">自动 — 目标为最后停止的烹饪 Auto — targets last ended cook</span>
    </div>
  </div>

  <div id="staff-selector">
    <strong>厨师名字 Chef Name</strong>
    <button class="staff-btn" id="staff-AhDong" onclick="setGlobalStaff('Ah Dong')">啊东Ah Dong</button>
    <button class="staff-btn" id="staff-HuaYun" onclick="setGlobalStaff('Hua Yun')">华云Hua Yun</button>
    <button class="staff-btn" id="staff-Siva" onclick="setGlobalStaff('Siva')">Siva</button>
    <button class="staff-btn" id="staff-XiaoHe" onclick="setGlobalStaff('Xiao He')">小赫Xiao He</button>
  </div>

  <div id="active-cooks">
    <div class="active-header">
      <h2>现煮的食品 Active / Running Cooks</h2>
      <div class="bulk-actions">
        <button class="bulk-btn start-all-btn" onclick="startAllCooks()">🔥 开始全部 Start All</button>
        <button class="bulk-btn end-all-btn" onclick="endAllCooks()">⏹️ 停止全部 End All</button>
      </div>
    </div>
    <div class="active-grid" id="active-grid"></div>
  </div>

  <div id="menu">
    <h2>选择要开始烹饪的食物 Select Food to Start Cooking</h2>

    <!-- Chicken Category -->
    <div class="food-category">
      <h3 class="category-header">🐔 鸡肉 Chicken</h3>
      <div class="food-grid">
        <div class="food-card" onclick="addNewCook('烤蜜汁鸡翅膀 Grilled Honey Chicken Wings')">
          <span>
            <div class="chinese">烤蜜汁鸡翅膀</div>
            <div class="english">Grilled Honey Chicken Wings</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('泰式香兰叶鸡 Roasted Chicken W Pandan Asian Spices')">
          <span>
            <div class="chinese">泰式香兰叶鸡</div>
            <div class="english">Roasted Chicken W Pandan Asian Spices</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('蜜汁鸡 Honey Glazed Chicken')">
          <span>
            <div class="chinese">蜜汁鸡</div>
            <div class="english">Honey Glazed Chicken</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤日式鸡 Grilled Teriyaki Chicken')">
          <span>
            <div class="chinese">烤日式鸡</div>
            <div class="english">Grilled Teriyaki Chicken</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('鸡肉卷,牛油挞子酱 Chicken Roulade with Butter Berry Raisin Sauce')">
          <span>
            <div class="chinese">鸡肉卷,牛油挞子酱</div>
            <div class="english">Chicken Roulade with Butter Berry Raisin Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤无骨鸡肉与BBQ酱和黄梨番茄莎莎 Grilled Chicken w Pineapple Salsa')">
          <span>
            <div class="chinese">烤无骨鸡肉与BBQ酱和黄梨番茄莎莎</div>
            <div class="english">Grilled Chicken w Pineapple Salsa</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('鸡肉沙爹(大) Jumbo Chicken Satay')">
          <span>
            <div class="chinese">鸡肉沙爹(大)</div>
            <div class="english">Jumbo Chicken Satay</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤印第安鸡与小番茄 Grilled Cajun Chicken Breast')">
          <span>
            <div class="chinese">烤印第安鸡与小番茄</div>
            <div class="english">Grilled Cajun Chicken Breast</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('黄姜娘惹烤鸡 Ayam Panggang Kunyit')">
          <span>
            <div class="chinese">黄姜娘惹烤鸡</div>
            <div class="english">Ayam Panggang Kunyit</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鸡与迷迭香草药 Grilled Chicken with Rosemary')">
          <span>
            <div class="chinese">烤鸡与迷迭香草药</div>
            <div class="english">Grilled Chicken with Rosemary</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('药材鸡 Baked Herbal Chicken')">
          <span>
            <div class="chinese">药材鸡</div>
            <div class="english">Baked Herbal Chicken</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('黑胡椒鸡肉与灯笼椒串 Black Pepper Capsicum Skewer (Kebab)')">
          <span>
            <div class="chinese">黑胡椒鸡肉与灯笼椒串</div>
            <div class="english">Black Pepper Capsicum Skewer (Kebab)</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('黑胡椒烤鸡 Grilled Black Pepper Chicken')">
          <span>
            <div class="chinese">黑胡椒烤鸡</div>
            <div class="english">Grilled Black Pepper Chicken</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('日式鸡翅膀 Japanese Chicken Wings')">
          <span>
            <div class="chinese">日式鸡翅膀</div>
            <div class="english">Japanese Chicken Wings</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('印第安小鸡翅 Cajun Chicken Winglets')">
          <span>
            <div class="chinese">印第安小鸡翅</div>
            <div class="english">Cajun Chicken Winglets</div>
          </span>
        </div>
      </div>
    </div>

    <!-- Fish Category -->
    <div class="food-category">
      <h3 class="category-header">🐟 鱼类 Fish</h3>
      <div class="food-grid">
        <div class="food-card" onclick="addNewCook('港式蒸鱼与炸蒜，酱青和姜丝 HK Style Baked Fish w Garlic Soya Sauce')">
          <span>
            <div class="chinese">港式蒸鱼与炸蒜，酱青和姜丝</div>
            <div class="english">HK Style Baked Fish w Garlic Soya Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鱼片与参巴辣椒，烤洋葱 Grilled Fish Fillet w Chef Sambal Belachan & Sweet Onion')">
          <span>
            <div class="chinese">烤鱼片与参巴辣椒，烤洋葱</div>
            <div class="english">Grilled Fish Fillet w Chef Sambal Belachan & Sweet Onion</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('咖喱亚参鱼头 Nonya Curry Assam Ikan')">
          <span>
            <div class="chinese">咖喱亚参鱼头</div>
            <div class="english">Nonya Curry Assam Ikan</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('咖喱亚参鱼片 Curry Assam Fish Fillet')">
          <span>
            <div class="chinese">咖喱亚参鱼片</div>
            <div class="english">Curry Assam Fish Fillet</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鱼片与娘惹香料 Grilled Fish Fillet with Nonya Spices')">
          <span>
            <div class="chinese">烤鱼片与娘惹香料</div>
            <div class="english">Grilled Fish Fillet with Nonya Spices</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鱼片与日式酱 Grilled Fish Fillet w Teriyaki Sauce')">
          <span>
            <div class="chinese">烤鱼片与日式酱</div>
            <div class="english">Grilled Fish Fillet w Teriyaki Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤辣椒澳洲肺鱼片 Grilled Whole Barramundi Fillet Balado')">
          <span>
            <div class="chinese">烤辣椒澳洲肺鱼片</div>
            <div class="english">Grilled Whole Barramundi Fillet Balado</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤三文鱼片，日式酱 Grilled Salmon Fillet w Teriyaki Sauce')">
          <span>
            <div class="chinese">烤三文鱼片，日式酱</div>
            <div class="english">Grilled Salmon Fillet w Teriyaki Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('意式香草烤鱼 Grilled Fish Fillet w Italian Herbs & White Sauce')">
          <span>
            <div class="chinese">意式香草烤鱼</div>
            <div class="english">Grilled Fish Fillet w Italian Herbs & White Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鱼片与白酱 Grilled Fish w Creamy White Sauce')">
          <span>
            <div class="chinese">烤鱼片与白酱</div>
            <div class="english">Grilled Fish w Creamy White Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鲈鱼全鱼自制辣椒(整只) Grilled Whole Seabass w Homemade Sambal')">
          <span>
            <div class="chinese">烤鲈鱼全鱼自制辣椒(整只)</div>
            <div class="english">Grilled Whole Seabass w Homemade Sambal</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('参巴鱼片与灯笼椒和红葱头 Ikan Goreng Sambal Tumis')">
          <span>
            <div class="chinese">参巴鱼片与灯笼椒和红葱头</div>
            <div class="english">Ikan Goreng Sambal Tumis</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('泰式烤鱼与酸橙蒜茸和香菜 Thai Style Baked Fish w Lime Garlic & Cilantro')">
          <span>
            <div class="chinese">泰式烤鱼与酸橙蒜茸和香菜</div>
            <div class="english">Thai Style Baked Fish w Lime Garlic & Cilantro</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤白酱东炎鱼片 Grilled Fish Fillet w Creamy Tom Yum Sauce')">
          <span>
            <div class="chinese">烤白酱东炎鱼片</div>
            <div class="english">Grilled Fish Fillet w Creamy Tom Yum Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤鱼片与黄梨和红葱头 Baked Fish Fillet Topped w Sarawak Pineapple & Red Onions')">
          <span>
            <div class="chinese">烤鱼片与黄梨和红葱头</div>
            <div class="english">Baked Fish Fillet Topped w Sarawak Pineapple & Red Onions</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('咖喱亚参鱼头 Curry Assam Fish head')">
          <span>
            <div class="chinese">咖喱亚参鱼头</div>
            <div class="english">Curry Assam Fish head</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤亚参鱼与番茄，茄子和羊角豆 Assam Fish Fillet w Tomato, Lady's finger and Brinjal')">
          <span>
            <div class="chinese">烤亚参鱼与番茄，茄子和羊角豆</div>
            <div class="english">Assam Fish Fillet w Tomato, Lady's finger and Brinjal</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤澳洲肺鱼头片与参巴酱 Grilled Barramundi Fish Head with Chef Sambal Topped With Lady's Finger')">
          <span>
            <div class="chinese">烤澳洲肺鱼头片与参巴酱</div>
            <div class="english">Grilled Barramundi Fish Head with Chef Sambal Topped With Lady's Finger</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤澳洲肺鱼片与参巴酱 Grilled Barramundi Fillet w Chef's Sambal')">
          <span>
            <div class="chinese">烤澳洲肺鱼片与参巴酱</div>
            <div class="english">Grilled Barramundi Fillet w Chef's Sambal</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤澳洲肺鱼片与参巴酱 Grilled Barramundi Fillet w Creamy Italian Herbs & Tomato Confit')">
          <span>
            <div class="chinese">烤澳洲肺鱼片与参巴酱</div>
            <div class="english">Grilled Barramundi Fillet w Creamy Italian Herbs & Tomato Confit</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤澳洲肺鱼片与白酱东炎 Grilled Barramundi Fillet w Creamy Tom Yum Sauce')">
          <span>
            <div class="chinese">烤澳洲肺鱼片与白酱东炎</div>
            <div class="english">Grilled Barramundi Fillet w Creamy Tom Yum Sauce</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('咖喱亚参澳洲肺鱼片 Curry Assam Barramundi Fish Fillet')">
          <span>
            <div class="chinese">咖喱亚参澳洲肺鱼片</div>
            <div class="english">Curry Assam Barramundi Fish Fillet</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('泰式烤鱼 Thai Style Grilled Fish')">
          <span>
            <div class="chinese">泰式烤鱼</div>
            <div class="english">Thai Style Grilled Fish</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('亚参鱼 Ikan Assam Pedas')">
          <span>
            <div class="chinese">亚参鱼</div>
            <div class="english">Ikan Assam Pedas</div>
          </span>
        </div>
      </div>
    </div>

    <!-- Vegetable Category -->
    <div class="food-category">
      <h3 class="category-header">🥬 蔬菜 Vegetables</h3>
      <div class="food-grid">
        <div class="food-card" onclick="addNewCook('烤根茎类蔬菜 Roasted Root Vegetable')">
          <span>
            <div class="chinese">烤根茎类蔬菜</div>
            <div class="english">Roasted Root Vegetable</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤金瓜 Roasted Pumpkin')">
          <span>
            <div class="chinese">烤金瓜</div>
            <div class="english">Roasted Pumpkin</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤土豆与蒜茸和迷迭香 Oven Baked Potato w Garlic & Rosemary')">
          <span>
            <div class="chinese">烤土豆与蒜茸和迷迭香</div>
            <div class="english">Oven Baked Potato w Garlic & Rosemary</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤土豆与香草和甜洋葱 Roasted Potato with Herbs & Sweet Onions')">
          <span>
            <div class="chinese">烤土豆与香草和甜洋葱</div>
            <div class="english">Roasted Potato with Herbs & Sweet Onions</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('烤土豆与金瓜 Grilled Potato and Pumpkin')">
          <span>
            <div class="chinese">烤土豆与金瓜</div>
            <div class="english">Grilled Potato and Pumpkin</div>
          </span>
        </div>
      </div>
    </div>

    <!-- Others Category -->
    <div class="food-category">
      <h3 class="category-header">🍽️ 其他 Others</h3>
      <div class="food-grid">
        <div class="food-card" onclick="addNewCook('烤参巴虾 Grilled Prawn w Homemade Sambal')">
          <span>
            <div class="chinese">烤参巴虾</div>
            <div class="english">Grilled Prawn w Homemade Sambal</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('亚参汁 Assam Gravy')">
          <span>
            <div class="chinese">亚参汁</div>
            <div class="english">Assam Gravy</div>
          </span>
        </div>
        <div class="food-card" onclick="addNewCook('其他 Others')">
          <span>
            <div class="chinese">其他</div>
            <div class="english">Others</div>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div id="status"></div>

  <div id="log">
    <h3>最近记录（最后8条） Recent Entries (last 8)</h3>
    <table id="recent-table">
      <thead>
        <tr>
          <th class="food-col">食物 Food Item</th>
          <th class="date-col">开始日期 Start Date</th>
          <th class="time-col">开始时间 Start Time</th>
          <th class="time-col">结束时间 End Time</th>
          <th class="small-col">时长(分) Duration (min)</th>
          <th class="small-col">核心温度(°C) Core Temp</th>
          <th class="small-col">厨师 Staff</th>
          <th class="small-col">盘数 Trays</th>
        </tr>
      </thead>
      <tbody id="recent-body"></tbody>
    </table>
    <button onclick="exportFullCSV()" class="export-btn">
      下载完整CSV Download Full CSV
    </button>
  </div>

  <script src="../data.js"></script>
  <script src="../app.js"></script>
  <script>
    // ============================================================
    // BLUETOOTH — ETI Thermapen One Blue (ETI GATT Spec v2.0)
    // Private Service:  45544942-4c55-4554-4845-524db87ad700
    // Sensor 1 Reading: 45544942-4c55-4554-4845-524db87ad701 (Read & Notify)
    //   IEEE-754 float32 little-endian, always in °C
    //   Fault = [0xff,0xff,0xff,0xff]
    // Commands:         45544942-4c55-4554-4845-524db87ad705 (Read/Write & Notify)
    //   Write 0x0010 (uint16 LE) to trigger a measurement
    //   Notification 0x0001 = button pressed (reading incoming)
    // ============================================================
    const ETI_SERVICE = '45544942-4c55-4554-4845-524db87ad700';
    const ETI_SENSOR1 = '45544942-4c55-4554-4845-524db87ad701';
    const ETI_COMMAND = '45544942-4c55-4554-4845-524db87ad705';
    const CMD_MEASURE = new Uint8Array([0x10, 0x00]); // 0x0010 LE

    const btStatus  = document.getElementById('bt-status');
    const btConnect = document.getElementById('bt-connect');
    const btRead    = document.getElementById('bt-read');
    const btTemp    = document.getElementById('bt-temp');

    let btDevice       = null;
    let btSensor1      = null;
    let btCommandChar  = null;
    let _buttonPressed = false; // true when physical Thermapen button triggered this read

    function setBtStatus(msg) { btStatus.textContent = msg; }

    function setBtTemp(temp) {
      btTemp.textContent = (temp !== null && !isNaN(temp)) ? `${temp.toFixed(1)} °C` : '';
    }

    // ETI format: 4 bytes float32 LE in °C; fault = 0xFFFFFFFF
    function parseEtiTemp(dataView) {
      if (dataView.byteLength < 4) return null;
      if (dataView.getUint8(0) === 0xff && dataView.getUint8(1) === 0xff &&
          dataView.getUint8(2) === 0xff && dataView.getUint8(3) === 0xff) {
        setBtStatus('⚠️ 探头故障 — 检查探头连接 Sensor fault — check probe connection');
        return null;
      }
      const t = dataView.getFloat32(0, true);
      if (t < -200 || t > 1372) { console.warn('ETI temp out of range:', t); return null; }
      return t;
    }

    // ── Shared GATT connection logic (used by both auto and manual connect) ──
    async function gattConnect(device) {
      btDevice = device;
      setBtStatus('连接中… Connecting…');

      const server  = await btDevice.gatt.connect();
      setBtStatus('获取ETI服务… Getting ETI service…');
      const service = await server.getPrimaryService(ETI_SERVICE);

      setBtStatus('获取特性… Getting characteristics…');
      btSensor1     = await service.getCharacteristic(ETI_SENSOR1);
      btCommandChar = await service.getCharacteristic(ETI_COMMAND);

      await btSensor1.startNotifications();
      btSensor1.addEventListener('characteristicvaluechanged', handleTempNotification);

      await btCommandChar.startNotifications();
      btCommandChar.addEventListener('characteristicvaluechanged', (ev) => {
        const code = ev.target.value.getUint16(0, true);
        if (code === 0x0001) {
          _buttonPressed = true;  // next Sensor1 notification should lock in + save
          setBtStatus('🔴 按键已按下 — 锁定温度中… Button pressed — locking in temp…');
        }
        if (code === 0x0002) { setBtStatus('⏻ Thermapen 正在关机 Shutting down'); setBtTemp(null); btRead.disabled = true; }
      });

      const name = btDevice.name || 'Thermapen';
      setBtStatus(`✓ ${name} 已连接 Connected — 按设备按键或点击读取温度 press button or Read Temp`);
      btRead.disabled  = false;
      btConnect.textContent = '🔄 重新配对 Re-pair';

      // Remove any old listener before adding new one to avoid duplicates
      btDevice.removeEventListener('gattserverdisconnected', onDisconnected);
      btDevice.addEventListener('gattserverdisconnected', onDisconnected);
    }

    // ── Auto-reconnect on unexpected disconnect — retries every 5 s until success ──
    let _reconnectTimeout = null;
    let _reconnectAttempt  = 0;

    function onDisconnected() {
      setBtTemp(null);
      btRead.disabled = true;
      btSensor1 = null;
      btCommandChar = null;
      _reconnectAttempt = 0;
      clearTimeout(_reconnectTimeout);
      scheduleReconnect();
    }

    function scheduleReconnect() {
      if (!btDevice) return;
      _reconnectAttempt++;
      setBtStatus(`⚠️ 已断开 — 5秒后第${_reconnectAttempt}次重连… Disconnected — reconnecting in 5s (attempt ${_reconnectAttempt})…`);
      _reconnectTimeout = setTimeout(async () => {
        if (!btDevice) return;
        try {
          setBtStatus(`🔄 第${_reconnectAttempt}次重连中… Reconnecting (attempt ${_reconnectAttempt})…`);
          await gattConnect(btDevice);
          _reconnectAttempt = 0; // success — reset counter
        } catch (err) {
          // Device still unavailable — schedule another attempt
          scheduleReconnect();
        }
      }, 5000);
    }

    // ── Auto-connect on page load using previously permitted device ──
    async function autoConnectThermometer() {
      if (!navigator.bluetooth || !navigator.bluetooth.getDevices) return;
      try {
        const devices = await navigator.bluetooth.getDevices();
        const thermapen = devices.find(d => d.name && d.name.startsWith('Thermapen'));
        if (!thermapen) return; // No remembered device yet
        setBtStatus(`🔵 已记住 ${thermapen.name} — 自动连接中… Remembered — auto-connecting…`);
        btConnect.disabled = true;
        await gattConnect(thermapen);
        btConnect.disabled = false;
      } catch (err) {
        // Device may be off or out of range — silently set a friendly hint
        const saved = (btDevice && btDevice.name) ? btDevice.name : 'Thermapen';
        setBtStatus(`💤 已记住 ${saved} — 开机后自动连接或点击重新配对 Remembered — will auto-connect when on`);
        btConnect.disabled = false;
        console.warn('Auto-connect skipped:', err.message);
      }
    }

    // ── Manual connect button: shows picker (first-time or re-pair) ──
    async function connectThermometer() {
      try {
        setBtStatus('打开设备选择器… Opening device picker…');
        setBtTemp(null);
        btConnect.disabled = true;

        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { namePrefix: 'Thermapen' },
            { manufacturerData: [{ companyIdentifier: 0x0376 }] }
          ],
          optionalServices: [ETI_SERVICE]
        });

        await gattConnect(device);
        btConnect.disabled = false;
      } catch (err) {
        console.error('BT connect error:', err);
        if (err.name === 'NotFoundError') setBtStatus('❌ 未选择设备 No device selected.');
        else if (err.name === 'SecurityError') setBtStatus('❌ 蓝牙被封锁 — 需要HTTPS Bluetooth blocked — needs HTTPS.');
        else setBtStatus(`❌ ${err.message}`);
        btRead.disabled = true;
        btConnect.disabled = false;
      }
    }

    function handleTempNotification(event) {
      const temp = parseEtiTemp(event.target.value);
      if (temp === null) return;

      setBtTemp(temp);
      const name = btDevice ? btDevice.name || 'Thermapen' : 'Thermapen';

      // Small hold: wait 120ms in case 0x0001 command notification is still in flight
      setTimeout(() => {
        const wasButtonPress = _buttonPressed;
        _buttonPressed = false;
        const label = document.getElementById('bt-target-label');

        if (wasButtonPress) {
          // ── Physical button press: lock in temp on ALL finished cook cards and save each ──
          const finished = (typeof cooks !== 'undefined') ? cooks.filter(c => c.endTime) : [];
          if (finished.length === 0) {
            setBtStatus(`⚠️ ${name} — ${temp.toFixed(1)} °C — 没有已停止的烹饪 No finished cooks to save`);
            return;
          }
          const tempStr = temp.toFixed(1);
          finished.forEach(cook => {
            cook.temp = tempStr;
            const el = document.getElementById(`temp-input-${cook.id}`);
            if (el) el.innerHTML = `<span class="temp-value">${tempStr}</span><span class="temp-unit">°C</span>`;
          });
          setBtStatus(`🔒 ${name} — ${tempStr} °C → 正在保存 ${finished.length} 个… Saving ${finished.length} card(s)…`);
          if (label) label.textContent = `🔒 已锁定 ${tempStr} °C — 保存 ${finished.length} 个 Locked & saving ${finished.length}`;
          // Save each one sequentially (small stagger to avoid hammering the server)
          finished.forEach((cook, i) => {
            setTimeout(() => {
              if (typeof window.saveCook === 'function') window.saveCook(cook.id);
            }, i * 300);
          });
        } else {
          // ── Manual Read button or auto-triggered: display on targeted card only ──
          const updatedId = (typeof setLatestCookTemp === 'function') ? setLatestCookTemp(temp.toFixed(1)) : null;
          setBtStatus(`✓ ${name} — ${temp.toFixed(1)} °C`);
          if (label) {
            const cook = (typeof cooks !== 'undefined' && updatedId !== null) ? cooks.find(c => c.id === updatedId) : null;
            label.textContent = cook
              ? `✓ ${cook.food.split(' ').slice(0,3).join(' ')} — ${temp.toFixed(1)} °C (按保存 press SAVE)`
              : `✓ ${temp.toFixed(1)} °C`;
          }
        }
      }, 120);
    }

    // Read Temp button: write Measure command (0x0010) → response fires as Sensor 1 notification
    async function readTemperature() {
      if (!btCommandChar) { setBtStatus('❌ Not connected'); return; }
      try {
        setBtStatus('请求测量中… Requesting measurement…');
        await btCommandChar.writeValue(CMD_MEASURE);
      } catch (err) {
        console.error('Read error:', err);
        setBtStatus(`❌ ${err.message}`);
      }
    }

    // Attach event listeners
    btConnect.addEventListener('click', connectThermometer);
    btRead.addEventListener('click', readTemperature);

    // Auto-connect to remembered device on page load (no picker shown)
    autoConnectThermometer();

    // Called automatically by endCook() in app.js when a cook is stopped.
    // Sends the BT Measure command so the reading arrives in that card.
    window.requestBtReadForCook = function(cookId) {
      const label = document.getElementById('bt-target-label');
      const cook = (typeof cooks !== 'undefined') ? cooks.find(c => c.id === cookId) : null;
      if (label) label.textContent = cook
        ? `🌡️ 目标: ${cook.food.split(' ').slice(0,3).join(' ')} — 按设备按键锁定 Target set — press device button to lock in`
        : '🌡️ 目标已设定 Target set — press device button to lock in';
      if (btCommandChar) {
        readTemperature();
      }
      // If not connected, just leave target set — chef can connect and press Read Temp
    };

    // ============================================================
    // APP INITIALIZATION
    // ============================================================
    // Auto-select first staff member
    autoSelectFirstStaff();
    // Load recent entries on page load
    loadRecent();
  </script>
</body>
</html>

